<% @title = "History of Changes for #{@resource.class.name.titleize} #{@resource.id}" %>

<div class="grid_12">
  <h2><%= @title %></h2>

  <div class="report">
    <table>
      <thead>
        <tr>
          <th>Version</th>
          <th>Date</th>
          <th>User</th>
          <th colspan="2">Changes</th>
        </tr>
      </thead>
      <tbody>
        <% @resource.audits.each do |revision| %>
          <tr>
            <td><%= revision.version %></td>
            <td><%= revision.created_at.to_s(:long) %></td>
            <td>
              <% if revision.user %>
                <%= revision.user.try(:email) %>
              <% else %>
                <% if revision.audited_changes.keys.include?('updated_by_id') %>
                  <%
                    user = case revision.audited_changes['updated_by_id']
                    when Fixnum then User.find_by_id(revision.audited_changes['updated_by_id'])
                    when Array then User.find_by_id(revision.audited_changes['updated_by_id'].last)
                    end
                  %>
                  <% if user %>
                    <%= user.try(:email) %>
                  <% end %>
                <% end %>
              <% end %>
            </td>
            <% if revision.action == "create" %>
              <td colspan="2">creation of the object</td>
            <% else %>
              <td><%= revision.audited_changes.keys.join('<br />').html_safe %></td>
              <td>
                <% values = revision.audited_changes.values.collect { |val| "'#{val[0] ||= 'null'}' => '#{val[1]}'" } %>
                <%= values.join('<br />').html_safe %>
              </td>
            <% end %>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>
</div>
