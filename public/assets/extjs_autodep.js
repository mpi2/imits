Ext.define("Imits.data.JsonReader",{extend:"Ext.data.reader.Json",alias:null,readRecords:function(a){if(!this.getRoot(a)&&!Ext.isEmpty(a.id)){a=[a]}return this.callParent([a])},getResponseData:function(a){if(a.request.options.method=="DELETE"&&a.status==200){return{}}else{return this.callParent([a])}}});Ext.define("Imits.data.JsonWriter",{extend:"Ext.data.writer.Json",writeAllFields:false,write:function(a){var b=this.callParent([a]);b.params.authenticity_token=window.authenticityToken;if(b.jsonData[this.root]&&b.jsonData[this.root]["id"]){delete b.jsonData[this.root]["id"]}if(b.action==="destroy"&&!Ext.isEmpty(b.params)){b.url=Ext.urlAppend(b.url,Ext.urlEncode(b.params));b.jsonData=null;b.params=null}return b}});Ext.define("Imits.Util",{statics:{handleErrorResponse:function(a){var b=Ext.JSON.decode(a.responseText);var c=function(){var d=[];if(b.hasOwnProperty("backtrace")){delete b.backtrace}Ext.Object.each(b,function(f,g){var e=Ext.String.capitalize(f).replace(/_/g," ")+": ";if(Ext.isString(g)){e+=g}else{if(Ext.isArray){e+=g.join(", ")}}d.push(Ext.String.htmlEncode(e))});return d.join("<br/>")};Ext.MessageBox.show({title:"Error",msg:c(b),icon:Ext.MessageBox.ERROR,buttons:Ext.Msg.OK,fn:function(e,f,d){}})},extractValueIfExistent:function(a,c){if(Ext.isEmpty(a)||!a.hasOwnProperty(c)){return undefined}var b=a[c];if(!Ext.isEmpty(b)){return b}else{return undefined}}}});Ext.define("Imits.data.Proxy",{extend:"Ext.data.proxy.Rest",requires:["Imits.data.JsonWriter","Imits.data.JsonReader","Imits.Util"],constructor:function(b){var a=b.resource;var c=a+"s";if(b.resourcePath){c=b.resourcePath}this.callParent([{format:"json",url:window.basePath+"/"+c,extraParams:{extended_response:true},startParam:undefined,limitParam:"per_page",sortParam:"sorts",reader:Ext.create("Imits.data.JsonReader",{root:a+"s"}),writer:Ext.create("Imits.data.JsonWriter",{root:a,writeAllFields:false}),listeners:{exception:function(e,f,d){Imits.Util.handleErrorResponse(f)}},encodeSorters:function(e){if(e.length===0){return""}else{var d=e[0];return d.property+" "+d.direction.toLowerCase()}}}])}});Ext.define("Imits.model.Gene",{extend:"Ext.data.Model",requires:["Imits.data.Proxy"],fields:[{name:"id",type:"int",readOnly:true},{name:"marker_symbol",readOnly:true},{name:"mgi_accession_id",readOnly:true},{name:"ikmc_projects_count",readOnly:true},{name:"pretty_print_types_of_cells_available",readOnly:true},{name:"non_assigned_mi_plans",readOnly:true},{name:"assigned_mi_plans",readOnly:true},{name:"pretty_print_aborted_mi_attempts",readOnly:true},{name:"pretty_print_mi_attempts_in_progress",readOnly:true},{name:"pretty_print_mi_attempts_genotype_confirmed",readOnly:true},{name:"pretty_print_phenotype_attempts",readOnly:true}],proxy:Ext.create("Imits.data.Proxy",{resource:"gene"})});Ext.define("Imits.model.MiAttempt",{extend:"Ext.data.Model",requires:["Imits.data.Proxy"],fields:[{name:"id",type:"int",persist:false},{name:"es_cell_name",persist:false},{name:"es_cell_marker_symbol",persist:false},{name:"es_cell_allele_symbol",persist:false},{name:"mi_date",type:"date"},{name:"status_name",persist:false},"colony_name",{name:"consortium_name"},{name:"production_centre_name"},"distribution_centres_attributes",{name:"distribution_centres_formatted_display",readOnly:true},"blast_strain_name",{name:"total_blasts_injected",type:"int"},{name:"total_transferred",type:"int"},{name:"number_surrogates_receiving",type:"int"},{name:"total_pups_born",type:"int"},{name:"total_female_chimeras",type:"int"},{name:"total_male_chimeras",type:"int"},{name:"total_chimeras",type:"int",persist:false},{name:"number_of_males_with_0_to_39_percent_chimerism",type:"int"},{name:"number_of_males_with_40_to_79_percent_chimerism",type:"int"},{name:"number_of_males_with_80_to_99_percent_chimerism",type:"int"},{name:"number_of_males_with_100_percent_chimerism",type:"int"},{name:"emma_status"},{name:"test_cross_strain_name"},{name:"colony_background_strain_name"},{name:"date_chimeras_mated",type:"date"},{name:"number_of_chimera_matings_attempted",type:"int"},{name:"number_of_chimera_matings_successful",type:"int"},{name:"number_of_chimeras_with_glt_from_cct",type:"int"},{name:"number_of_chimeras_with_glt_from_genotyping",type:"int"},{name:"number_of_chimeras_with_0_to_9_percent_glt",type:"int"},{name:"number_of_chimeras_with_10_to_49_percent_glt",type:"int"},{name:"number_of_chimeras_with_50_to_99_percent_glt",type:"int"},{name:"number_of_chimeras_with_100_percent_glt",type:"int"},{name:"total_f1_mice_from_matings",type:"int"},{name:"number_of_cct_offspring",type:"int"},{name:"number_of_het_offspring",type:"int"},{name:"number_of_live_glt_offspring",type:"int"},{name:"mouse_allele_type",readOnly:true},{name:"mouse_allele_symbol",readOnly:true},"qc_southern_blot_result","qc_five_prime_lr_pcr_result","qc_five_prime_cassette_integrity_result","qc_tv_backbone_assay_result","qc_neo_count_qpcr_result","qc_neo_sr_pcr_result","qc_loa_qpcr_result","qc_homozygous_loa_sr_pcr_result","qc_lacz_sr_pcr_result","qc_mutant_specific_sr_pcr_result","qc_loxp_confirmation_result","qc_three_prime_lr_pcr_result",{name:"report_to_public",type:"boolean"},{name:"is_active",type:"boolean"},{name:"is_released_from_genotyping",type:"boolean"},{name:"phenotype_attempts_count",type:"int",readOnly:true,persist:false},{name:"mi_plan_id",type:"int"}],proxy:Ext.create("Imits.data.Proxy",{resource:"mi_attempt"})});Ext.define("Imits.model.MiPlan",{extend:"Ext.data.Model",requires:["Imits.data.Proxy"],fields:[{name:"id",type:"int",persist:false},{name:"marker_symbol"},{name:"consortium_name"},{name:"production_centre_name"},{name:"status_name"},{name:"priority_name"},{name:"sub_project_name"},{name:"number_of_es_cells_starting_qc"},{name:"number_of_es_cells_passing_qc"},{name:"withdrawn",defaultValue:false},{name:"is_active",defaultValue:true},{name:"is_bespoke_allele",defaultValue:false},{name:"es_qc_comment_name"},{name:"phenotype_only",defaultValue:false},{name:"is_conditional_allele",defaultValue:false},{name:"is_deletion_allele",defaultValue:false},{name:"is_cre_knock_in_allele",defaultValue:false},{name:"is_cre_bac_allele",defaultValue:false},{name:"is_conditional_allele",defaultValue:false},{name:"comment"},{name:"mi_attempts_count",readOnly:true,persist:false},{name:"phenotype_attempts_count",readOnly:true,persist:false}],proxy:Ext.create("Imits.data.Proxy",{resource:"mi_plan"})});Ext.define("Imits.model.PhenotypeAttempt",{extend:"Ext.data.Model",requires:["Imits.data.Proxy"],fields:[{name:"id",type:"int",persist:false},{name:"colony_name"},{name:"consortium_name"},{name:"production_centre_name"},{name:"distribution_centres_formatted_display",readOnly:true},{name:"mi_attempt_colony_name",readOnly:true,persist:false},{name:"marker_symbol"},{name:"is_active"},{name:"status_name",persist:false,readOnly:true},{name:"rederivation_started"},{name:"rederivation_complete"},{name:"deleter_strain_name"},{name:"number_of_cre_matings_successful"},{name:"phenotyping_started"},{name:"phenotyping_complete"},{name:"mi_plan_id",type:"int"}],proxy:Ext.create("Imits.data.Proxy",{resource:"phenotype_attempt"})});Ext.define("Imits.model.SolrUpdateQueueItem",{extend:"Ext.data.Model",requires:["Imits.data.Proxy"],fields:[{name:"id",type:"int",persist:false},{name:"reference"},{name:"action"},{name:"created_at"}],proxy:Ext.create("Imits.data.Proxy",{resource:"solr_update_queue_item",resourcePath:"solr_update/queue/items"})});Ext.define("Imits.model.Contact",{extend:"Ext.data.Model",requires:["Imits.data.Proxy"],fields:[{name:"id",type:"int",persist:false},{name:"email"}],proxy:Ext.create("Imits.data.Proxy",{resource:"admin_contact",resourcePath:"admin/contacts"})});Ext.define("Imits.model.Notification",{extend:"Ext.data.Model",requires:["Imits.data.Proxy"],fields:[{name:"id",type:"int",persist:false},{name:"contact_id"},{name:"contact_email"},{name:"gene_id"},{name:"gene_marker_symbol"},{name:"welcome_email_sent"},{name:"last_email_sent"},{name:"welcome_email"},{name:"last_email"},{name:"updated_at"}],proxy:Ext.create("Imits.data.Proxy",{resource:"admin_notification",resourcePath:"admin/notifications"})});Ext.define("Imits.model.ProductionGoal",{extend:"Ext.data.Model",requires:["Imits.data.Proxy"],fields:[{name:"id",type:"int",persist:false},{name:"consortium_name"},{name:"year"},{name:"month"},{name:"mi_goal"},{name:"gc_goal"}],proxy:Ext.create("Imits.data.Proxy",{resource:"production_goal"})});Ext.define("Imits.widget.ManageResizeWithBrowserFrame",{manageResize:function(){var b=window.innerHeight-30;if(!b){b=document.documentElement.clientHeight-30}var a=b-this.getEl().getTop();if(a<200){a=200}this.setHeight(a);this.setWidth(this.getEl().up("div").getWidth()-1);this.doLayout()}});Ext.define("Imits.widget.Grid",{extend:"Ext.grid.Panel",mixins:["Imits.widget.ManageResizeWithBrowserFrame"],reloadStore:function(){var a=this.getStore();a.sync();a.load()}});Ext.define("Ext.ux.grid.menu.ListMenu",{extend:"Ext.menu.Menu",labelField:"text",loadingText:"Loading...",loadOnShow:true,single:false,constructor:function(b){var e=this,d,c,a,f;e.selected=[];e.addEvents("checkchange");e.callParent([b=b||{}]);if(!b.store&&b.options){d=[];for(c=0,a=b.options.length;c<a;c++){f=b.options[c];switch(Ext.type(f)){case"array":d.push(f);break;case"object":d.push([f.id,f[e.labelField]]);break;case"string":d.push([f,f]);break}}e.store=Ext.create("Ext.data.ArrayStore",{fields:["id",e.labelField],data:d,listeners:{load:e.onLoad,scope:e}});e.loaded=true;e.autoStore=true}else{e.add({text:e.loadingText,iconCls:"loading-indicator"});e.store.on("load",e.onLoad,e)}},destroy:function(){var b=this,a=b.store;if(a){if(b.autoStore){a.destroyStore()}else{a.un("unload",b.onLoad,b)}}b.callParent()},show:function(){if(this.loadOnShow&&!this.loaded&&!this.store.loading){this.store.load()}this.callParent()},onLoad:function(d,c){var g=this,f,h,e,a,b={checkchange:g.checkChange,scope:g};Ext.suspendLayouts();g.removeAll(true);f=g.single?Ext.id():null;for(e=0,a=c.length;e<a;e++){h=c[e].get("id");g.add(Ext.create("Ext.menu.CheckItem",{text:c[e].get(g.labelField),group:f,checked:Ext.Array.contains(g.selected,h),hideOnClick:false,value:h,listeners:b}))}g.loaded=true;Ext.resumeLayouts(true);g.fireEvent("load",g,c)},getSelected:function(){return this.selected},setSelected:function(a){a=this.selected=[].concat(a);if(this.loaded){this.items.each(function(d){d.setChecked(false,true);for(var c=0,b=a.length;c<b;c++){if(d.value==a[c]){d.setChecked(true,true)}}},this)}},checkChange:function(b,a){var c=[];this.items.each(function(d){if(d.checked){c.push(d.value)}},this);this.selected=c;this.fireEvent("checkchange",b,a)}});Ext.define("Ext.ux.grid.menu.RangeMenu",{extend:"Ext.menu.Menu",fieldCls:"Ext.form.field.Number",itemIconCls:{gt:"ux-rangemenu-gt",lt:"ux-rangemenu-lt",eq:"ux-rangemenu-eq"},fieldLabels:{gt:"Greater Than",lt:"Less Than",eq:"Equal To"},menuItemCfgs:{emptyText:"Enter Number...",selectOnFocus:false,width:155},menuItems:["lt","gt","-","eq"],constructor:function(c){var f=this,a,j,b,d,g,e,h;f.callParent(arguments);a=f.fields=f.fields||{};j=f.fieldCfg=f.fieldCfg||{};f.addEvents("update");f.updateTask=Ext.create("Ext.util.DelayedTask",f.fireUpdate,f);for(b=0,d=f.menuItems.length;b<d;b++){g=f.menuItems[b];if(g!=="-"){e={itemId:"range-"+g,enableKeyEvents:true,hideLabel:false,fieldLabel:f.iconTpl.apply({cls:f.itemIconCls[g]||"no-icon",text:f.fieldLabels[g]||"",src:Ext.BLANK_IMAGE_URL}),labelSeparator:"",labelWidth:29,labelStyle:"position: relative;",listeners:{scope:f,change:f.onInputChange,keyup:f.onInputKeyUp,el:{click:function(i){i.stopPropagation()}}},activate:Ext.emptyFn,deactivate:Ext.emptyFn};Ext.apply(e,Ext.applyIf(a[g]||{},j[g]),f.menuItemCfgs);h=e.fieldCls||f.fieldCls;g=a[g]=Ext.create(h,e)}f.add(g)}},fireUpdate:function(){this.fireEvent("update",this)},getValue:function(){var b={},a,c;for(a in this.fields){c=this.fields[a];if(c.isValid()&&c.getValue()!==null){b[a]=c.getValue()}}return b},setValue:function(c){var b=this,a,d;for(a in b.fields){d=b.fields[a];d.suspendEvents();d.setValue(a in c?c[a]:"");d.resumeEvents()}b.fireEvent("update",b)},onInputKeyUp:function(b,a){if(a.getKey()===a.RETURN&&b.isValid()){a.stopEvent();this.hide()}},onInputChange:function(f){var d=this,e=d.fields,b=e.eq,c=e.gt,a=e.lt;if(f==b){if(c){c.setValue(null)}if(a){a.setValue(null)}}else{b.setValue(null)}this.updateTask.delay(this.updateBuffer)}},function(){this.prototype.iconTpl=Ext.create("Ext.XTemplate",'<img src="{src}" alt="{text}" class="'+Ext.baseCSSPrefix+'menu-item-icon ux-rangemenu-icon {cls}" />')});Ext.define("Ext.ux.grid.filter.Filter",{extend:"Ext.util.Observable",active:false,dataIndex:null,menu:null,updateBuffer:500,constructor:function(a){Ext.apply(this,a);this.addEvents("activate","deactivate","serialize","update");Ext.ux.grid.filter.Filter.superclass.constructor.call(this);this.menu=this.createMenu(a);this.init(a);if(a&&a.value){this.setValue(a.value);this.setActive(a.active!==false,true);delete a.value}},destroy:function(){if(this.menu){this.menu.destroy()}this.clearListeners()},init:Ext.emptyFn,createMenu:function(a){return Ext.create("Ext.menu.Menu",a)},getValue:Ext.emptyFn,setValue:Ext.emptyFn,isActivatable:function(){return true},getSerialArgs:Ext.emptyFn,validateRecord:function(){return true},serialize:function(){var a=this.getSerialArgs();this.fireEvent("serialize",a,this);return a},fireUpdate:function(){if(this.active){this.fireEvent("update",this)}this.setActive(this.isActivatable())},setActive:function(b,a){if(this.active!=b){this.active=b;if(a!==true){this.fireEvent(b?"activate":"deactivate",this)}}}});Ext.define("Ext.ux.grid.filter.BooleanFilter",{extend:"Ext.ux.grid.filter.Filter",alias:"gridfilter.boolean",defaultValue:false,yesText:"Yes",noText:"No",init:function(b){var c=Ext.id();this.options=[Ext.create("Ext.menu.CheckItem",{text:this.yesText,group:c,checked:this.defaultValue===true}),Ext.create("Ext.menu.CheckItem",{text:this.noText,group:c,checked:this.defaultValue===false})];this.menu.add(this.options[0],this.options[1]);for(var a=0;a<this.options.length;a++){this.options[a].on("click",this.fireUpdate,this);this.options[a].on("checkchange",this.fireUpdate,this)}},getValue:function(){return this.options[0].checked},setValue:function(a){this.options[a?0:1].setChecked(true)},getSerialArgs:function(){var a={type:"boolean",value:this.getValue()};return a},validateRecord:function(a){return a.get(this.dataIndex)==this.getValue()}});Ext.define("Ext.ux.grid.filter.DateFilter",{extend:"Ext.ux.grid.filter.Filter",alias:"gridfilter.date",uses:["Ext.picker.Date","Ext.menu.Menu"],afterText:"After",beforeText:"Before",compareMap:{before:"lt",after:"gt",on:"eq"},dateFormat:"m/d/Y",menuItems:["before","after","-","on"],menuItemCfgs:{selectOnFocus:true,width:125},onText:"On",pickerOpts:{},init:function(d){var g=this,f,c,a,e,b;f=Ext.apply(g.pickerOpts,{xtype:"datepicker",minDate:g.minDate,maxDate:g.maxDate,format:g.dateFormat,listeners:{scope:g,select:g.onMenuSelect}});g.fields={};for(c=0,a=g.menuItems.length;c<a;c++){e=g.menuItems[c];if(e!=="-"){b={itemId:"range-"+e,text:g[e+"Text"],menu:Ext.create("Ext.menu.Menu",{items:[Ext.apply(f,{itemId:e,listeners:{select:g.onPickerSelect,scope:g}}),]}),listeners:{scope:g,checkchange:g.onCheckChange}};e=g.fields[e]=Ext.create("Ext.menu.CheckItem",b)}g.menu.add(e)}g.values={}},onCheckChange:function(e,d){var c=this,a=e.menu.items.first(),f=a.itemId,b=c.values;if(d){b[f]=a.getValue()}else{delete b[f]}c.setActive(c.isActivatable());c.fireEvent("update",c)},onInputKeyUp:function(c,b){var a=b.getKey();if(a==b.RETURN&&c.isValid()){b.stopEvent();this.menu.hide()}},onMenuSelect:function(b,a){var c=this.fields,d=this.fields[b.itemId];d.setChecked(true);if(d==c.on){c.before.setChecked(false,true);c.after.setChecked(false,true)}else{c.on.setChecked(false,true);if(d==c.after&&this.getFieldValue("before")<a){c.before.setChecked(false,true)}else{if(d==c.before&&this.getFieldValue("after")>a){c.after.setChecked(false,true)}}}this.fireEvent("update",this);b.up("menu").hide()},getValue:function(){var a,b={};for(a in this.fields){if(this.fields[a].checked){b[a]=this.getFieldValue(a)}}return b},setValue:function(c,a){var b;for(b in this.fields){if(c[b]){this.getPicker(b).setValue(c[b]);this.fields[b].setChecked(true)}else{if(!a){this.fields[b].setChecked(false)}}}this.fireEvent("update",this)},isActivatable:function(){var a;for(a in this.fields){if(this.fields[a].checked){return true}}return false},getSerialArgs:function(){var a=[];for(var b in this.fields){if(this.fields[b].checked){a.push({type:"date",comparison:this.compareMap[b],value:Ext.Date.format(this.getFieldValue(b),this.dateFormat)})}}return a},getFieldValue:function(a){return this.values[a]},getPicker:function(a){return this.fields[a].menu.items.first()},validateRecord:function(c){var a,e,d=c.get(this.dataIndex),b=Ext.Date.clearTime;if(!Ext.isDate(d)){return false}d=b(d,true).getTime();for(a in this.fields){if(this.fields[a].checked){e=b(this.getFieldValue(a),true).getTime();if(a=="before"&&e<=d){return false}if(a=="after"&&e>=d){return false}if(a=="on"&&e!=d){return false}}}return true},onPickerSelect:function(b,a){this.values[b.itemId]=a;this.fireEvent("update",this)}});Ext.define("Ext.ux.grid.filter.ListFilter",{extend:"Ext.ux.grid.filter.Filter",alias:"gridfilter.list",phpMode:false,init:function(a){this.dt=Ext.create("Ext.util.DelayedTask",this.fireUpdate,this)},createMenu:function(a){var b=Ext.create("Ext.ux.grid.menu.ListMenu",a);b.on("checkchange",this.onCheckChange,this);return b},getValue:function(){return this.menu.getSelected()},setValue:function(a){this.menu.setSelected(a);this.fireEvent("update",this)},isActivatable:function(){return this.getValue().length>0},getSerialArgs:function(){return{type:"list",value:this.phpMode?this.getValue().join(","):this.getValue()}},onCheckChange:function(){this.dt.delay(this.updateBuffer)},validateRecord:function(b){var a=this.getValue();return Ext.Array.indexOf(a,b.get(this.dataIndex))>-1}});Ext.define("Ext.ux.grid.filter.NumericFilter",{extend:"Ext.ux.grid.filter.Filter",alias:"gridfilter.numeric",uses:["Ext.form.field.Number"],createMenu:function(a){var b=this,c;c=Ext.create("Ext.ux.grid.menu.RangeMenu",a);c.on("update",b.fireUpdate,b);return c},getValue:function(){return this.menu.getValue()},setValue:function(a){this.menu.setValue(a)},isActivatable:function(){var b=this.getValue(),a;for(a in b){if(b[a]!==undefined){return true}}return false},getSerialArgs:function(){var b,a=[],c=this.menu.getValue();for(b in c){a.push({type:"numeric",comparison:b,value:c[b]})}return a},validateRecord:function(c){var d=c.get(this.dataIndex),b=this.getValue(),a=Ext.isNumber;if(a(b.eq)&&d!=b.eq){return false}if(a(b.lt)&&d>=b.lt){return false}if(a(b.gt)&&d<=b.gt){return false}return true}});Ext.define("Ext.ux.grid.filter.StringFilter",{extend:"Ext.ux.grid.filter.Filter",alias:"gridfilter.string",iconCls:"ux-gridfilter-text-icon",emptyText:"Enter Filter Text...",selectOnFocus:true,width:125,init:function(a){Ext.applyIf(a,{enableKeyEvents:true,iconCls:this.iconCls,hideLabel:true,listeners:{scope:this,keyup:this.onInputKeyUp,el:{click:function(b){b.stopPropagation()}}}});this.inputItem=Ext.create("Ext.form.field.Text",a);this.menu.add(this.inputItem);this.updateTask=Ext.create("Ext.util.DelayedTask",this.fireUpdate,this)},getValue:function(){return this.inputItem.getValue()},setValue:function(a){this.inputItem.setValue(a);this.fireEvent("update",this)},isActivatable:function(){return this.inputItem.getValue().length>0},getSerialArgs:function(){return{type:"string",value:this.getValue()}},validateRecord:function(a){var b=a.get(this.dataIndex);if(typeof b!="string"){return(this.getValue().length===0)}return b.toLowerCase().indexOf(this.getValue().toLowerCase())>-1},onInputKeyUp:function(c,b){var a=b.getKey();if(a==b.RETURN&&c.isValid()){b.stopEvent();this.menu.hide();return}this.updateTask.delay(this.updateBuffer)}});Ext.define("Ext.ux.grid.FiltersFeature",{extend:"Ext.grid.feature.Feature",alias:"feature.filters",uses:["Ext.ux.grid.menu.ListMenu","Ext.ux.grid.menu.RangeMenu","Ext.ux.grid.filter.BooleanFilter","Ext.ux.grid.filter.DateFilter","Ext.ux.grid.filter.ListFilter","Ext.ux.grid.filter.NumericFilter","Ext.ux.grid.filter.StringFilter"],autoReload:true,filterCls:"ux-filtered-column",local:false,menuFilterText:"Filters",paramPrefix:"filter",showMenu:true,stateId:undefined,updateBuffer:500,hasFeatureEvent:false,constructor:function(a){var b=this;a=a||{};Ext.apply(b,a);b.deferredUpdate=Ext.create("Ext.util.DelayedTask",b.reload,b);b.filters=b.createFiltersCollection();b.filterConfigs=a.filters},attachEvents:function(){var c=this,a=c.view,d=a.headerCt,b=c.getGridPanel();c.bindStore(a.getStore(),true);d.on("menucreate",c.onMenuCreate,c);a.on("refresh",c.onRefresh,c);b.on({scope:c,beforestaterestore:c.applyState,beforestatesave:c.saveState,beforedestroy:c.destroy});b.filters=c;b.addEvents("filterupdate")},createFiltersCollection:function(){return Ext.create("Ext.util.MixedCollection",false,function(a){return a?a.dataIndex:null})},createFilters:function(){var h=this,g=h.filters.getCount(),a=h.getGridPanel(),e=h.createFiltersCollection(),d=a.store.model,c=d.prototype.fields,i,f,b;if(g){b={};h.saveState(null,b)}function j(l,m,k){if(l&&(k||m)){i=c.get(l);f={dataIndex:l,type:(i&&i.type&&i.type.type)||"auto"};if(Ext.isObject(m)){Ext.apply(f,m)}e.replace(f)}}Ext.Array.each(h.filterConfigs,function(k){j(k.dataIndex,k)});Ext.Array.each(a.columns,function(k){if(k.filterable===false){e.removeAtKey(k.dataIndex)}else{j(k.dataIndex,k.filter,k.filterable)}});h.removeAll();if(e.items){h.initializeFilters(e.items)}if(g){h.applyState(null,b)}},initializeFilters:function(a){var e=this,f=a.length,d,b,c;for(d=0;d<f;d++){b=a[d];if(b){c=e.getFilterClass(b.type);b=b.menu?b:new c(b);e.filters.add(b);Ext.util.Observable.capture(b,this.onStateChange,this)}}},onMenuCreate:function(c,b){var a=this;a.createFilters();b.on("beforeshow",a.onMenuBeforeShow,a)},onMenuBeforeShow:function(d){var c=this,b,a;if(c.showMenu){b=c.menuItem;if(!b||b.isDestroyed){c.createMenuItem(d);b=c.menuItem}a=c.getMenuFilter();if(a){b.setMenu(a.menu,false);b.setChecked(a.active);b.setDisabled(a.disabled===true)}b.setVisible(!!a);this.sep.setVisible(!!a)}},createMenuItem:function(b){var a=this;a.sep=b.add("-");a.menuItem=b.add({checked:false,itemId:"filters",text:a.menuFilterText,listeners:{scope:a,checkchange:a.onCheckChange,beforecheckchange:a.onBeforeCheck}})},getGridPanel:function(){return this.view.up("gridpanel")},applyState:function(c,e){var d=this,b,a;d.applyingState=true;d.clearFilters();if(e.filters){for(b in e.filters){if(e.filters.hasOwnProperty(b)){a=d.filters.get(b);if(a){a.setValue(e.filters[b]);a.setActive(true)}}}}d.deferredUpdate.cancel();if(d.local){d.reload()}delete d.applyingState;delete e.filters},saveState:function(b,c){var a={};this.filters.each(function(d){if(d.active){a[d.dataIndex]=d.getValue()}});return(c.filters=a)},destroy:function(){var a=this;Ext.destroyMembers(a,"menuItem","sep");a.removeAll();a.clearListeners()},removeAll:function(){if(this.filters){Ext.destroy.apply(Ext,this.filters.items);this.filters.clear()}},bindStore:function(a){var b=this;if(b.store&&b.storeListeners){b.store.un(b.storeListeners)}if(a){b.storeListeners={scope:b};if(b.local){b.storeListeners.load=b.onLoad}else{b.storeListeners["before"+(a.buffered?"prefetch":"load")]=b.onBeforeLoad}a.on(b.storeListeners)}else{delete b.storeListeners}b.store=a},getMenuFilter:function(){var a=this.view.headerCt.getMenu().activeHeader;return a?this.filters.get(a.dataIndex):null},onCheckChange:function(a,b){this.getMenuFilter().setActive(b)},onBeforeCheck:function(a,b){return !b||this.getMenuFilter().isActivatable()},onStateChange:function(d,a){if(d!=="serialize"){var c=this,b=c.getGridPanel();if(a==c.getMenuFilter()){c.menuItem.setChecked(a.active,false)}if((c.autoReload||c.local)&&!c.applyingState){c.deferredUpdate.delay(c.updateBuffer)}c.updateColumnHeadings();if(!c.applyingState){b.saveState()}b.fireEvent("filterupdate",c,a)}},onBeforeLoad:function(a,b){b.params=b.params||{};this.cleanParams(b.params);var c=this.buildQuery(this.getFilterData());Ext.apply(b.params,c)},onLoad:function(a){a.filterBy(this.getRecordFilter())},onRefresh:function(){this.updateColumnHeadings()},updateColumnHeadings:function(){var a=this,b=a.view.headerCt;if(b){b.items.each(function(d){var c=a.getFilter(d.dataIndex);d[c&&c.active?"addCls":"removeCls"](a.filterCls)})}},reload:function(){var b=this,a=b.view.getStore();if(b.local){a.clearFilter(true);a.filterBy(b.getRecordFilter());a.sort()}else{b.deferredUpdate.cancel();if(a.buffered){a.pageMap.clear()}a.loadPage(1)}},getRecordFilter:function(){var c=[],a,b;this.filters.each(function(d){if(d.active){c.push(d)}});a=c.length;return function(d){for(b=0;b<a;b++){if(!c[b].validateRecord(d)){return false}}return true}},addFilter:function(e){var f=this,d=f.getGridPanel().columns,c,h,b,g,a;for(c=0,h=d.length;c<h;c++){b=d[c];if(b.dataIndex===e.dataIndex){b.filter=e}}if(f.view.headerCt.menu){f.createFilters()}else{f.view.headerCt.getMenu()}for(c=0,g=f.filters.items.length;c<g;c++){a=f.filters.items[c];if(a.dataIndex===e.dataIndex){return a}}},addFilters:function(a){if(a){var c=this,b,d;for(b=0,d=a.length;b<d;b++){c.addFilter(a[b])}}},getFilter:function(a){return this.filters.get(a)},clearFilters:function(){this.filters.each(function(a){a.setActive(false)})},getFilterData:function(){var b=[],c,a;this.filters.each(function(e){if(e.active){var g=[].concat(e.serialize());for(c=0,a=g.length;c<a;c++){b.push({field:e.dataIndex,data:g[c]})}}});return b},buildQuery:function(g){var a={},c,h,j,d,k,b,e=g.length;if(!this.encode){for(c=0;c<e;c++){h=g[c];j=[this.paramPrefix,"[",c,"]"].join("");a[j+"[field]"]=h.field;d=j+"[data]";for(k in h.data){a[[d,"[",k,"]"].join("")]=h.data[k]}}}else{b=[];for(c=0;c<e;c++){h=g[c];b.push(Ext.apply({},{field:h.field},h.data))}if(b.length>0){a[this.paramPrefix]=Ext.JSON.encode(b)}}return a},cleanParams:function(c){if(this.encode){delete c[this.paramPrefix]}else{var b,a;b=new RegExp("^"+this.paramPrefix+"[[0-9]+]");for(a in c){if(b.test(a)){delete c[a]}}}},getFilterClass:function(a){switch(a){case"auto":a="string";break;case"int":case"float":a="numeric";break;case"bool":a="boolean";break}return Ext.ClassManager.getByAlias("gridfilter."+a)}});Ext.define("Imits.widget.grid.RansackFiltersFeature",{extend:"Ext.ux.grid.FiltersFeature",alias:"feature.ransack_filters",encode:false,buildQuerySingle:function(b){var c={};switch(b.data.type){case"numeric":if(b.data.comparison!="eq"){c["q["+b.field+"_"+b.data.comparison+"]"]=b.data.value}else{c["q["+b.field+"_in][]"]=b.data.value}break;case"string":if(b.field=="id"){c["q["+b.field+"_in][]"]=b.data.value.split(",")}else{c["q["+b.field+"_ci_in][]"]=b.data.value}break;case"list":c["q["+b.field+"_ci_in][]"]=b.data.value;break;case"boolean":c["q["+b.field+"_eq]"]=b.data.value;break;case"date":var a=b.data.value.split("/");c["q["+b.field+"_"+b.data.comparison+"]"]=[a[2]+"-"+a[0]+"-"+a[1]];break}return c},buildQuery:function(a){var c={};var b=this;Ext.each(a,function(d){var f=b.buildQuerySingle(d);for(var e in f){c[e]=f[e]}});return c},cleanParams:function(c){var b,a;b=new RegExp("^q\\[\\w+_ci_in\\]$");for(a in c){if(b.test(a)){delete c[a]}}}});Ext.define("Imits.widget.SimpleCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.simplecombo",typeAhead:false,triggerAction:"all",forceSelection:true,editable:false,constructor:function(a){if(a.storeOptionsAreSpecial==true){var b=function(c){if(Ext.isEmpty(c)){return[c,window.NO_BREAK_SPACE]}else{return[c,Ext.String.htmlEncode(c)]}};a.store=Ext.Array.map(a.store,b)}this.callParent([a])},initComponent:function(){this.callParent();if(this.storeOptionsAreSpecial==true){this.displayTpl=Ext.create("Ext.XTemplate",'<tpl for=".">{[typeof values === "string" ? values : values["'+this.valueField+'"]]}<tpl if="xindex < xcount">'+this.delimiter+"</tpl></tpl>")}}});Ext.define("Imits.widget.Window",{extend:"Ext.window.Window",plain:true,showLoadMask:function(){this.loadMask=new Ext.LoadMask(this.getComponent(0).getEl());this.loadMask.show()},hideLoadMask:function(){this.loadMask.hide()}});Ext.define("Imits.widget.SimpleCheckbox",{extend:"Ext.form.field.Checkbox",alias:"widget.simplecheckbox",editor:{xtype:"checkbox",cls:"x-grid-checkheader-editor"},renderer:function(b){var a="x-grid-checkheader";if(b===true){a+=" x-grid-checkheader-checked"}return'<div class="'+a+'"></div>'},filter:{type:"boolean",defaultValue:null}});Ext.define("Imits.widget.MiPlanEditor",{extend:"Imits.widget.Window",requires:["Imits.model.MiPlan","Imits.widget.SimpleCombo","Imits.widget.SimpleCheckbox"],title:"Change Gene Interest",resizable:false,layout:"fit",closeAction:"hide",cls:"plan editor",constructor:function(a){if(Ext.isIE7||Ext.isIE8){a.width=400}return this.callParent([a])},initComponent:function(){var c=this;this.callParent();var b=true;if(window.CAN_SEE_SUB_PROJECT){b=false}this.form=Ext.create("Ext.form.Panel",{ui:"plain",margin:"0 0 10 0",width:360,layout:"anchor",defaults:{anchor:"100%",labelWidth:150,labelAlign:"right",labelPad:10},items:[{id:"marker_symbol",xtype:"textfield",fieldLabel:"Gene marker symbol",name:"marker_symbol",readOnly:true},{id:"consortium_name",xtype:"simplecombo",fieldLabel:"Consortium",name:"consortium_name",storeOptionsAreSpecial:true,store:window.CONSORTIUM_OPTIONS},{id:"production_centre_name",xtype:"simplecombo",fieldLabel:"Production Centre",name:"production_centre_name",storeOptionsAreSpecial:true,store:window.CENTRE_OPTIONS},{id:"status_name",xtype:"textfield",fieldLabel:"Status",name:"status_name",readOnly:true},{id:"priority_name",xtype:"simplecombo",fieldLabel:"Priority",name:"priority_name",store:window.PRIORITY_OPTIONS},{id:"phenotype_only",xtype:"simplecheckbox",fieldLabel:"Phenotype only?",name:"phenotype_only"},{id:"is_conditional_allele",xtype:"simplecheckbox",fieldLabel:"Conditional allele?",name:"is_conditional_allele"},{id:"is_deletion_allele",xtype:"simplecheckbox",fieldLabel:"Deletion allele?",name:"is_deletion_allele"},{id:"is_cre_knock_in_allele",xtype:"simplecheckbox",fieldLabel:"Cre knock-in allele?",name:"is_cre_knock_in_allele"},{id:"is_cre_bac_allele",xtype:"simplecheckbox",fieldLabel:"Cre BAC allele?",name:"is_cre_bac_allele"},{id:"is_bespoke_allele",xtype:"simplecheckbox",fieldLabel:"Bespoke allele?",name:"is_bespoke_allele",hidden:b},{id:"comment",xtype:"textfield",fieldLabel:"Allele Type Comment",name:"comment"},{id:"sub_project_name",xtype:"simplecombo",fieldLabel:"Sub-Project",name:"sub_project_name",storeOptionsAreSpecial:true,store:window.SUB_PROJECT_OPTIONS,hidden:b},{id:"number_of_es_cells_starting_qc",xtype:"simplenumberfield",fieldLabel:"# of ES Cells starting QC",name:"number_of_es_cells_starting_qc"},{id:"number_of_es_cells_passing_qc",xtype:"simplenumberfield",fieldLabel:"# of ES Cells passing QC",name:"number_of_es_cells_passing_qc"},{id:"es_qc_comment_name",xtype:"simplecombo",fieldLabel:"ES QC Comment",name:"es_qc_comment_name",storeOptionsAreSpecial:true,store:window.ES_QC_COMMENT_NAMES}],buttons:[{id:"update-button",text:"<strong>Update</strong>",handler:function(g){g.disable();var h=null;if(Ext.isEmpty(c.miPlan.get("number_of_es_cells_passing_qc"))&&!Ext.isEmpty(c.form.getComponent("number_of_es_cells_passing_qc").getValue())){if(c.form.getComponent("number_of_es_cells_passing_qc").getValue()==0){h='Saving these changes will force the status to "Aborted - ES Cell QC Failed"'}else{h='Saving these changes will force the status to "Assigned - ES Cell QC Complete"'}}else{if(Ext.isEmpty(c.miPlan.get("number_of_es_cells_starting_qc"))&&!Ext.isEmpty(c.form.getComponent("number_of_es_cells_starting_qc").getValue())){h='Saving these changes will force the status to "Assigned - ES Cell QC In Progress"'}}if(!Ext.isEmpty(h)){Ext.Msg.show({title:"Notice",msg:h+" - is that OK?",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,closable:false,fn:function(i){if(i==="yes"){c.updateAndHide()}else{g.enable()}}})}else{c.updateAndHide()}}},{text:"Cancel",handler:function(){c.hide()}}]});var e=Ext.create("Ext.panel.Panel",{ui:"plain",layout:{type:"hbox",align:"stretchmax"},margin:"0 0 5 0",items:[{xtype:"label",text:"Delete interest?",cls:"x-form-item-label",margin:"0 5 0 0"},{xtype:"button",id:"delete-button",text:"Delete",width:60,handler:function(g){g.hide();e.getComponent("delete-confirmation-button").show()}},{xtype:"button",id:"delete-confirmation-button",text:"Are you sure?",width:100,hidden:true,handler:function(g){c.setLoading(true);c.miPlan.destroy({success:function(){c.setLoading(false);c.hide()}});g.hide();e.getComponent("delete-button").show()}}]});var f=Ext.create("Ext.panel.Panel",{ui:"plain",layout:{type:"hbox",align:"stretchmax"},margin:"0 0 5 0",items:[{xtype:"label",text:"Withdraw interest",cls:"x-form-item-label",margin:"0 5 0 0"},{xtype:"button",id:"withdraw-button",text:"Withdraw",width:60,handler:function(g){g.hide();f.getComponent("withdraw-confirmation-button").show()}},{xtype:"button",id:"withdraw-confirmation-button",text:"Are you sure?",width:100,hidden:true,handler:function(g){c.setLoading(true);var h=c.miPlan;h.set("withdrawn",true);c.miPlan.save({success:function(){c.setLoading(false);c.hide()}});g.hide();f.getComponent("withdraw-button").show()}}]});var a=Ext.create("Ext.panel.Panel",{ui:"plain",layout:{type:"hbox",align:"stretchmax"},margin:"0 0 5 0",items:[{xtype:"label",text:"Inactivate plan?",cls:"x-form-item-label",margin:"0 5 0 0"},{xtype:"button",id:"inactivate-button",text:"Inactivate",width:60,handler:function(g){g.hide();a.getComponent("inactivate-confirmation-button").show()}},{xtype:"button",id:"inactivate-confirmation-button",text:"Are you sure?",width:100,hidden:true,handler:function(g){c.setLoading(true);var h=c.miPlan;h.set("is_active",false);c.miPlan.save({success:function(){c.setLoading(false);c.hide()}});g.hide();a.getComponent("inactivate-button").show()}}]});var d=520;if(window.CAN_SEE_SUB_PROJECT){d=540}this.add(Ext.create("Ext.panel.Panel",{height:d,ui:"plain",layout:{type:"vbox",align:"stretchmax"},padding:5,items:[c.form,e,f,a]}));c.updateButton=Ext.getCmp("update-button");this.addListener("hide",function(){c.updateButton.enable()});c.withdrawButton=Ext.getCmp("withdraw-button");c.inactivateButton=Ext.getCmp("inactivate-button");this.fields=this.form.items.keys;this.updateableFields=this.form.items.filterBy(function(g){return g.readOnly!=true}).keys},edit:function(b){var a=this;Imits.model.MiPlan.load(b,{success:function(d){a.miPlan=d;Ext.each(a.fields,function(e){var f=a.form.getComponent(e);if(f){f.setValue(a.miPlan.get(e))}});a.show();var c=a.form.getComponent("consortium_name");if(c&&(d.get("mi_attempts_count")>0||d.get("phenotype_attempts_count")>0)){c.setReadOnly(true)}if(Ext.Array.indexOf(window.WITHDRAWABLE_STATUSES,d.get("status_name"))==-1){a.withdrawButton.disable()}else{a.withdrawButton.enable()}}})},updateAndHide:function(){var a=this;Ext.each(this.updateableFields,function(b){var c=a.form.getComponent(b);if(c){a.miPlan.set(b,c.getValue())}});a.miPlan.save({success:function(){a.hide()},failure:function(){a.updateButton.enable()}})}});Ext.define("Ext.ux.RowExpander",{extend:"Ext.AbstractPlugin",requires:["Ext.grid.feature.RowBody","Ext.grid.feature.RowWrap"],alias:"plugin.rowexpander",rowBodyTpl:null,expandOnEnter:true,expandOnDblClick:true,selectRowOnExpand:false,rowBodyTrSelector:".x-grid-rowbody-tr",rowBodyHiddenCls:"x-grid-row-body-hidden",rowCollapsedCls:"x-grid-row-collapsed",renderer:function(d,b,c,a,e){if(e===0){b.tdCls="x-grid-td-expander"}return'<div class="x-grid-row-expander">&#160;</div>'},constructor:function(){this.callParent(arguments);var b=this.getCmp();this.recordsExpanded={};if(!this.rowBodyTpl){Ext.Error.raise("The 'rowBodyTpl' config is required and is not defined.")}var c=Ext.create("Ext.XTemplate",this.rowBodyTpl),a=[{ftype:"rowbody",columnId:this.getHeaderId(),recordsExpanded:this.recordsExpanded,rowBodyHiddenCls:this.rowBodyHiddenCls,rowCollapsedCls:this.rowCollapsedCls,getAdditionalData:this.getRowBodyFeatureData,getRowBodyContents:function(d){return c.applyTemplate(d)}},{ftype:"rowwrap"}];if(b.features){b.features=a.concat(b.features)}else{b.features=a}},init:function(a){this.callParent(arguments);this.grid=a;this.addExpander();a.on("render",this.bindView,this,{single:true});a.on("reconfigure",this.onReconfigure,this)},onReconfigure:function(){this.addExpander()},addExpander:function(){this.grid.headerCt.insert(0,this.getHeaderConfig())},getHeaderId:function(){if(!this.headerId){this.headerId=Ext.id()}return this.headerId},getRowBodyFeatureData:function(c,a,b,f){var d=Ext.grid.feature.RowBody.prototype.getAdditionalData.apply(this,arguments),e=this.columnId;d.rowBodyColspan=d.rowBodyColspan-1;d.rowBody=this.getRowBodyContents(c);d.rowCls=this.recordsExpanded[b.internalId]?"":this.rowCollapsedCls;d.rowBodyCls=this.recordsExpanded[b.internalId]?"":this.rowBodyHiddenCls;d[e+"-tdAttr"]=' valign="top" rowspan="2" ';if(f[e+"-tdAttr"]){d[e+"-tdAttr"]+=f[e+"-tdAttr"]}return d},bindView:function(){var b=this.getCmp().getView(),a;if(!b.rendered){b.on("render",this.bindView,this,{single:true})}else{a=b.getEl();if(this.expandOnEnter){this.keyNav=Ext.create("Ext.KeyNav",a,{enter:this.onEnter,scope:this})}if(this.expandOnDblClick){b.on("itemdblclick",this.onDblClick,this)}this.view=b}},onEnter:function(h){var c=this.view,g=c.store,j=c.getSelectionModel(),a=j.getSelection(),f=a.length,d=0,b;for(;d<f;d++){b=g.indexOf(a[d]);this.toggleRow(b)}},toggleRow:function(b){var a=this.view,f=a.getNode(b),g=Ext.get(f),d=Ext.get(g).down(this.rowBodyTrSelector),e=a.getRecord(f),c=this.getCmp();if(g.hasCls(this.rowCollapsedCls)){g.removeCls(this.rowCollapsedCls);d.removeCls(this.rowBodyHiddenCls);this.recordsExpanded[e.internalId]=true;a.refreshSize();a.fireEvent("expandbody",f,e,d.dom)}else{g.addCls(this.rowCollapsedCls);d.addCls(this.rowBodyHiddenCls);this.recordsExpanded[e.internalId]=false;a.refreshSize();a.fireEvent("collapsebody",f,e,d.dom)}},onDblClick:function(c,a,b,d,f){this.toggleRow(b)},getHeaderConfig:function(){var c=this,a=Ext.Function.bind(c.toggleRow,c),b=c.selectRowOnExpand;return{id:this.getHeaderId(),width:24,sortable:false,resizable:false,draggable:false,hideable:false,menuDisabled:true,cls:Ext.baseCSSPrefix+"grid-header-special",renderer:function(e,d){d.tdCls=Ext.baseCSSPrefix+"grid-cell-special";return'<div class="'+Ext.baseCSSPrefix+'grid-row-expander">&#160;</div>'},processEvent:function(i,f,d,g,h,j){if(i=="mousedown"&&j.getTarget(".x-grid-row-expander")){var k=j.getTarget(".x-grid-row");a(k);return b}}}}});function splitResultString(b){var c=[];var a=/^\[(.+)\:(.+)\:(\d+)\]$/;Ext.Array.each(b.split("<br/>"),function(d){var e=a.exec(d);c.push({consortium:e[1],production_centre:e[2],count:e[3]})});return c}function printMiPlanString(a){var b="["+a.consortium;if(!Ext.isEmpty(a.production_centre)){b=b+":"+a.production_centre}if(!Ext.isEmpty(a.status_name)){b=b+":"+a.status_name}b=b+"]";return b}Ext.define("Imits.widget.GeneGrid",{extend:"Imits.widget.Grid",requires:["Imits.model.Gene","Imits.widget.grid.RansackFiltersFeature","Imits.widget.SimpleCombo","Imits.widget.MiPlanEditor","Ext.ux.RowExpander","Ext.selection.CheckboxModel"],title:"&nbsp;",iconCls:"icon-grid",columnLines:true,store:{model:"Imits.model.Gene",autoLoad:true,remoteSort:true,remoteFilter:true,pageSize:20},selModel:Ext.create("Ext.selection.CheckboxModel"),features:[{ftype:"ransack_filters",local:false}],columns:[{header:"Gene",dataIndex:"marker_symbol",readOnly:true,renderer:function(a){return Ext.String.format('<a href="http://www.knockoutmouse.org/martsearch/search?query={0}" target="_blank">{0}</a>',a)}},{header:"Tree",readOnly:true,renderer:function(e,c,b){var a=b.get("mgi_accession_id");var d='<img src="'+window.basePath+'/images/icons/application_side_tree.png" alt="Blah"/>';return Ext.String.format('<a href="{0}/genes/{1}/relationship_tree">{2}</a>',window.basePath,a,d)},width:40,sortable:false},{header:"Production History",dataIndex:"production_history_link",renderer:function(d,c,b){var a=b.getId();return Ext.String.format('<a href="{0}/genes/{1}/network_graph">Production Graph</a>',window.basePath,a)},sortable:false},{header:"# IKMC Projects",dataIndex:"ikmc_projects_count",readOnly:true},{header:"# Clones",dataIndex:"pretty_print_types_of_cells_available",readOnly:true,sortable:false},{header:"Non-Assigned Plans",dataIndex:"non_assigned_mi_plans",readOnly:true,sortable:false,width:250,flex:1,xtype:"templatecolumn",tpl:new Ext.XTemplate('<tpl for="non_assigned_mi_plans">','<a class="mi-plan" data-marker_symbol="{parent.marker_symbol}" data-id="{id}" data-string="{[this.prettyPrintMiPlan(values)]}" href="#">{[this.prettyPrintMiPlan(values)]}</a><br/>',"</tpl>",{prettyPrintMiPlan:printMiPlanString})},{header:"Assigned Plans",dataIndex:"assigned_mi_plans",readOnly:true,sortable:false,width:180,flex:1,xtype:"templatecolumn",tpl:new Ext.XTemplate('<tpl for="assigned_mi_plans">','<a class="mi-plan" data-marker_symbol="{parent.marker_symbol}" data-id="{id}" data-string="{[this.prettyPrintMiPlan(values)]}" href="#">{[this.prettyPrintMiPlan(values)]}</a><br/>',"</tpl>",{prettyPrintMiPlan:printMiPlanString})},{header:"Aborted MIs",dataIndex:"pretty_print_aborted_mi_attempts",readOnly:true,sortable:false,width:180,flex:1,xtype:"templatecolumn",tpl:new Ext.XTemplate('<tpl for="this.processedMIs(pretty_print_aborted_mi_attempts)">','<a href="'+window.basePath+'/mi_attempts?q[terms]={parent.marker_symbol}&q[production_centre_name]={production_centre}" target="_blank">[{consortium}:{production_centre}:{count}]</a></br>',"</tpl>",{processedMIs:splitResultString})},{header:"MIs in Progress",dataIndex:"pretty_print_mi_attempts_in_progress",readOnly:true,sortable:false,width:180,flex:1,xtype:"templatecolumn",tpl:new Ext.XTemplate('<tpl for="this.processedMIs(pretty_print_mi_attempts_in_progress)">','<a href="'+window.basePath+'/mi_attempts?q[terms]={parent.marker_symbol}&q[production_centre_name]={production_centre}" target="_blank">[{consortium}:{production_centre}:{count}]</a></br>',"</tpl>",{processedMIs:splitResultString})},{header:"Genotype Confirmed MIs",dataIndex:"pretty_print_mi_attempts_genotype_confirmed",readOnly:true,sortable:false,width:180,flex:1,xtype:"templatecolumn",tpl:new Ext.XTemplate('<tpl for="this.processedMIs(pretty_print_mi_attempts_genotype_confirmed)">','<a href="'+window.basePath+'/mi_attempts?q[terms]={parent.marker_symbol}&q[production_centre_name]={production_centre}" target="_blank">[{consortium}:{production_centre}:{count}]</a></br>',"</tpl>",{processedMIs:splitResultString})},{header:"Phenotype Attempts",dataIndex:"pretty_print_phenotype_attempts",readOnly:true,sortable:false,width:180,flex:1,xtype:"templatecolumn",tpl:new Ext.XTemplate('<tpl for="this.processedMIs(pretty_print_phenotype_attempts)">','<a href="'+window.basePath+'/phenotype_attempts?q[terms]={parent.marker_symbol}&q[production_centre_name]={production_centre}" target="_blank">[{consortium}:{production_centre}:{count}]</a></br>',"</tpl>",{processedMIs:splitResultString})}],createComboBox:function(f,c,e,a,d,b){if(d){a=Ext.Array.merge([null],a)}return Ext.create("Imits.widget.SimpleCombo",{id:f+"Combobox",store:a,fieldLabel:c,labelAlign:"right",labelWidth:e,storeOptionsAreSpecial:true,hidden:b})},registerInterestHandler:function(){var d=this;var c=0;var a=d.getSelectionModel().selected;var h=[];var g=d.consortiumCombo.getSubmitValue();var b=d.centreCombo.getSubmitValue();var f=d.subprojectCombo.getSubmitValue();var e=d.priorityCombo.getSubmitValue();if(a.length==0){alert("You must select some genes to register interest in");return}if(g==null){alert("You must select a consortium");return}if(e==null){alert("You must selct a priority");return}d.setLoading(true);a.each(function(j){var i=j.raw.marker_symbol;var k=Ext.create("Imits.model.MiPlan",{marker_symbol:i,consortium_name:g,production_centre_name:b,sub_project_name:f,priority_name:e});k.save({failure:function(){h.push(i)},callback:function(){c++;if(c==a.length){if(!Ext.isEmpty(h)){alert("An error occured trying to register interest on the following genes: "+h.join(", ")+". Please try again.")}d.reloadStore();d.setLoading(false)}}})})},initMiPlanEditor:function(){var a=this;this.miPlanEditor=Ext.create("Imits.widget.MiPlanEditor",{listeners:{hide:{fn:function(){a.reloadStore();a.setLoading(false)}}}});Ext.get(a.renderTo).on("click",function(b,d){var c=d.getAttribute("data-id");a.setLoading("Editing gene interest....");a.miPlanEditor.edit(c)},a,{delegate:"a.mi-plan"})},initComponent:function(){var b=this;b.callParent();b.addDocked(Ext.create("Ext.toolbar.Paging",{store:b.getStore(),dock:"bottom",displayInfo:true}));var a=true;if(window.CAN_SEE_SUB_PROJECT){a=false}b.consortiumCombo=b.createComboBox("consortium","Consortium",65,window.CONSORTIUM_OPTIONS,false,false);b.centreCombo=b.createComboBox("production_centre","Production Centre",100,window.CENTRE_OPTIONS,true,false);b.subprojectCombo=b.createComboBox("sub_project","Sub Project",65,window.SUB_PROJECT_OPTIONS,false,a);b.priorityCombo=b.createComboBox("priority","Priority",47,window.PRIORITY_OPTIONS,false,false);b.addDocked(Ext.create("Ext.toolbar.Toolbar",{dock:"top",items:[b.consortiumCombo,b.centreCombo,b.subprojectCombo,b.priorityCombo,"  ",{id:"register_interest_button",text:"Register Interest",cls:"x-btn-text-icon",iconCls:"icon-add",grid:b,handler:function(){b.registerInterestHandler()}}]}));this.initMiPlanEditor()}});Ext.define("Imits.widget.SimpleNumberField",{extend:"Ext.form.field.Number",alias:"widget.simplenumberfield",minValue:0,hideTrigger:true,keyNavEnabled:false,mouseWheelEnabled:false,allowDecimals:false});Ext.define("Imits.widget.QCCombo",{extend:"Imits.widget.SimpleCombo",alias:"widget.qccombo",store:window.MI_ATTEMPT_QC_OPTIONS});Ext.define("Imits.widget.grid.BoolGridColumn",{extend:"Ext.grid.Column",alias:"widget.boolgridcolumn",editor:{xtype:"checkbox",cls:"x-grid-checkheader-editor"},renderer:function(b){var a="x-grid-checkheader";if(b===true){a+=" x-grid-checkheader-checked"}return'<div class="'+a+'"></div>'},filter:{type:"boolean",defaultValue:null}});Ext.define("Imits.widget.grid.MiAttemptRansackFiltersFeature",{extend:"Imits.widget.grid.RansackFiltersFeature",alias:"feature.mi_attempt_ransack_filters",encode:false,buildQuery:function(a){var c=this.callParent([a]);var b=window.MI_ATTEMPT_SEARCH_PARAMS.terms;if(!Ext.isEmpty(b)){b=b.split("\n");c["q[es_cell_marker_symbol_or_es_cell_name_or_colony_name_ci_in][]"]=b}return c}});Ext.define("Imits.widget.grid.SimpleDateColumn",{extend:"Ext.grid.column.Date",alias:"widget.simpledatecolumn",format:"d-m-Y",editor:{xtype:"datefield",format:"d-m-Y"},filter:{type:"date"}});function splitString(a){var b=[];Ext.Array.each(a.split(", "),function(c){b.push({distributionCentre:c})});return b}Ext.define("Imits.widget.MiGrid",{extend:"Imits.widget.Grid",requires:["Imits.model.MiAttempt","Imits.widget.SimpleNumberField","Imits.widget.SimpleCombo","Imits.widget.QCCombo","Imits.widget.grid.BoolGridColumn","Imits.widget.grid.MiAttemptRansackFiltersFeature","Imits.widget.grid.SimpleDateColumn","Imits.Util"],title:"Micro-Injection Attempts",store:{model:"Imits.model.MiAttempt",autoLoad:true,autoSync:true,remoteSort:true,pageSize:20},selType:"rowmodel",plugins:[Ext.create("Ext.grid.plugin.RowEditing",{autoCancel:false,clicksToEdit:1})],features:[{ftype:"mi_attempt_ransack_filters",local:false}],generateColumns:function(b){var a=[];Ext.Object.each(this.groupedColumns,function(d,c){Ext.Array.each(c,function(f){var e;Ext.each(a,function(g){if(g.dataIndex==f.dataIndex&&g.header==f.header){e=g}});if(!e){f.tdCls="column-"+f.dataIndex;a.push(f)}})});b.columns=a},generateViews:function(){var b={};var d=Ext.pluck(this.groupedColumns.common,"dataIndex");var a=Ext.Array.merge(d,[]);Ext.Object.each(this.groupedColumns,function(g,f){if(g==="common"||g==="none"){return}var e=Ext.pluck(f,"dataIndex");b[g]=Ext.Array.merge(d,e);a=Ext.Array.merge(a,e)});b.Everything=a;var c=this;Ext.Object.each(this.additionalViewColumns,function(e){b[e]=Ext.Array.merge(d,c.additionalViewColumns[e])});this.views=b},constructor:function(a){if(a==undefined){a={}}this.generateColumns(a);this.generateViews();this.callParent([a])},switchViewButtonConfig:function(c,a){var b=this;return{text:c,enableToggle:true,allowDepress:false,toggleGroup:"mi_grid_view_config",minWidth:100,pressed:(a===true),listeners:{toggle:function(f,d){if(!d){return}function g(){var h=b.views[c];Ext.each(b.columns,function(i){if(Ext.Array.indexOf(h,i.dataIndex)==-1){i.setVisible(false)}else{i.setVisible(true)}});e.hide();Ext.getBody().removeCls("wait")}var e=new Ext.LoadMask(b.getEl(),{msg:"Please wait&hellip;",removeMask:true});Ext.getBody().addCls("wait");e.show();setTimeout(g,100)}}}},initComponent:function(){var a=this;a.callParent();a.addDocked(Ext.create("Ext.toolbar.Paging",{store:a.getStore(),dock:"bottom",displayInfo:true}));a.addDocked(Ext.create("Ext.container.ButtonGroup",{layout:"hbox",dock:"top",items:[a.switchViewButtonConfig("Everything",true),a.switchViewButtonConfig("Transfer Details"),a.switchViewButtonConfig("Litter Details"),a.switchViewButtonConfig("Chimera Mating Details"),a.switchViewButtonConfig("QC Details"),a.switchViewButtonConfig("Summary")]}));a.addListener("afterrender",function(){a.filters.createFilters()})},groupedColumns:{none:[{dataIndex:"id",header:"ID",readOnly:true,hidden:(Imits.Util.extractValueIfExistent(window.MI_ATTEMPT_SEARCH_PARAMS,"mi_attempt_id")?false:true),filter:{type:"string",value:Imits.Util.extractValueIfExistent(window.MI_ATTEMPT_SEARCH_PARAMS,"mi_attempt_id")}}],common:[{header:"Edit In Form",dataIndex:"edit_link",renderer:function(d,c,b){var a=b.getId();return Ext.String.format('<a href="{0}/mi_attempts/{1}">Edit in Form</a>',window.basePath,a)},sortable:false},{header:"Phenotype",dataIndex:"phenotype_attempt_new_link",renderer:function(e,d,c){var b=c.getId();var a=c.get("status_name");if(a=="Genotype confirmed"){return Ext.String.format('<a href="{0}/mi_attempts/{1}/phenotype_attempts/new">Create</a>',window.basePath,b)}else{return Ext.String.format("",window.basePath,b)}},sortable:false},{header:"Active Phenotype",dataIndex:"phenotype_attempts_count",readOnly:true,sortable:false,width:115,renderer:function(f,d,c){var b=c.getId();var a=c.get("phenotype_attempts_count");var e=c.get("es_cell_marker_symbol");if(a!=0){return Ext.String.format('<a href="{0}/phenotype_attempts?q[terms]={1}&q[production_centre_name]={2}"></a>',window.basePath,e,a)}else{return Ext.String.format("{0}",a)}}},{dataIndex:"consortium_name",header:"Consortium",readOnly:true,width:115,filter:{type:"list",options:window.MI_ATTEMPT_CONSORTIUM_OPTIONS,value:Imits.Util.extractValueIfExistent(window.MI_ATTEMPT_SEARCH_PARAMS,"consortium_name")},sortable:false},{dataIndex:"production_centre_name",header:"Production Centre",readOnly:true,filter:{type:"list",options:window.MI_ATTEMPT_CENTRE_OPTIONS,value:Imits.Util.extractValueIfExistent(window.MI_ATTEMPT_SEARCH_PARAMS,"production_centre_name")},sortable:false},{dataIndex:"es_cell_name",header:"ES Cell",readOnly:true,sortable:false,filter:{type:"string",value:Imits.Util.extractValueIfExistent(window.MI_ATTEMPT_SEARCH_PARAMS,"es_cell_name")}},{dataIndex:"es_cell_marker_symbol",header:"Marker Symbol",width:75,readOnly:true,sortable:false,filter:{type:"string",value:Imits.Util.extractValueIfExistent(window.MI_ATTEMPT_SEARCH_PARAMS,"es_cell_marker_symbol")}},{dataIndex:"es_cell_allele_symbol",header:"Allele symbol",readOnly:true,sortable:false},{xtype:"simpledatecolumn",dataIndex:"mi_date",header:"MI Date"},{dataIndex:"status_name",header:"Status",width:150,readOnly:true,sortable:false,filter:{type:"list",options:window.MI_ATTEMPT_STATUS_OPTIONS,value:Imits.Util.extractValueIfExistent(window.MI_ATTEMPT_SEARCH_PARAMS,"status_name")}},{dataIndex:"colony_name",header:"Colony Name",editor:"textfield",filter:{type:"string",value:Imits.Util.extractValueIfExistent(window.MI_ATTEMPT_SEARCH_PARAMS,"colony_name")}},{header:"Distribution Centres",dataIndex:"distribution_centres_formatted_display",readOnly:true,sortable:false,width:225,renderer:function(e,d,c){var a=c.getId();var b=c.get("distribution_centres_formatted_display");if(b!=""){return Ext.String.format('<a href="{0}/mi_attempts/{1}#distribution_centres" target="_blank">{2}</a>',window.basePath,a,b)}else{return Ext.String.format("{0}",b)}}}],"Transfer Details":[{dataIndex:"blast_strain_name",header:"Blast Strain",sortable:false,renderer:"safeTextRenderer",width:200,editor:{xtype:"simplecombo",store:Ext.Array.merge([""],window.MI_ATTEMPT_STRAIN_OPTIONS),storeOptionsAreSpecial:true,listConfig:{minWidth:200}}},{dataIndex:"total_blasts_injected",header:"Total Blasts Injected",editor:"simplenumberfield"},{dataIndex:"total_transferred",header:"Total Transferred",editor:"simplenumberfield"},{dataIndex:"number_surrogates_receiving",header:"# Surrogates Receiving",editor:"simplenumberfield"}],"Litter Details":[{dataIndex:"total_pups_born",header:"Total Pups Born",editor:"simplenumberfield"},{dataIndex:"total_female_chimeras",header:"Total Female Chimeras",editor:"simplenumberfield"},{dataIndex:"total_male_chimeras",header:"Total Male Chimeras",editor:"simplenumberfield"},{dataIndex:"total_chimeras",header:"Total Chimeras",readOnly:true},{dataIndex:"number_of_males_with_100_percent_chimerism",header:"100% Male Chimerism Levels",editor:"simplenumberfield"},{dataIndex:"number_of_males_with_80_to_99_percent_chimerism",header:"99-80% Male Chimerism Levels",editor:"simplenumberfield"},{dataIndex:"number_of_males_with_40_to_79_percent_chimerism",header:"79-40% Male Chimerism Levels",editor:"simplenumberfield"},{dataIndex:"number_of_males_with_0_to_39_percent_chimerism",header:"39-0% Male Chimerism Levels",editor:"simplenumberfield"}],"Chimera Mating Details":[{dataIndex:"test_cross_strain_name",header:"Test Cross Strain",readOnly:true,sortable:false,renderer:"safeTextRenderer",width:200,editor:{xtype:"simplecombo",store:Ext.Array.merge([""],window.MI_ATTEMPT_STRAIN_OPTIONS),storeOptionsAreSpecial:true,listConfig:{minWidth:200}}},{dataIndex:"colony_background_strain_name",header:"Colony Background Strain",readOnly:true,sortable:false,renderer:"safeTextRenderer",width:200,editor:{xtype:"simplecombo",store:Ext.Array.merge([""],window.MI_ATTEMPT_STRAIN_OPTIONS),storeOptionsAreSpecial:true,listConfig:{minWidth:200}}},{xtype:"simpledatecolumn",dataIndex:"date_chimeras_mated",header:"Date Chimeras Mated"},{dataIndex:"number_of_chimera_matings_attempted",header:"# Chimera Mating Attempted",editor:"simplenumberfield"},{dataIndex:"number_of_chimera_matings_successful",header:"# Chimera Matings Successful",editor:"simplenumberfield"},{dataIndex:"number_of_chimeras_with_glt_from_cct",header:"# Chimeras with Germline Transmission from CCT",editor:"simplenumberfield"},{dataIndex:"number_of_chimeras_with_glt_from_genotyping",header:"No. Chimeras with Germline Transmission from Genotyping",editor:"simplenumberfield"},{dataIndex:"number_of_chimeras_with_0_to_9_percent_glt",header:"# Chimeras with 0-9% GLT",editor:"simplenumberfield"},{dataIndex:"number_of_chimeras_with_10_to_49_percent_glt",header:"# Chimeras with 10-49% GLT",editor:"simplenumberfield"},{dataIndex:"number_of_chimeras_with_50_to_99_percent_glt",header:"No. Chimeras with 50-99% GLT",editor:"simplenumberfield"},{dataIndex:"number_of_chimeras_with_100_percent_glt",header:"No. Chimeras with 100% GLT",editor:"simplenumberfield"},{dataIndex:"total_f1_mice_from_matings",header:"Total F1 Mice from Matings",editor:"simplenumberfield"},{dataIndex:"number_of_cct_offspring",header:"# Coat Colour Transmission Offspring",editor:"simplenumberfield"},{dataIndex:"number_of_het_offspring",header:"# Het Offspring",editor:"simplenumberfield"},{dataIndex:"number_of_live_glt_offspring",header:"# Live GLT Offspring",editor:"simplenumberfield"},{dataIndex:"mouse_allele_type",header:"Mouse Allele Type",editor:{xtype:"simplecombo",store:window.MI_ATTEMPT_MOUSE_ALLELE_TYPE_OPTIONS,listConfig:{minWidth:300}}},{dataIndex:"mouse_allele_symbol",header:"Mouse Allele Symbol",readOnly:true}],"QC Details":[{dataIndex:"qc_southern_blot_result",header:"Southern Blot",sortable:false,editor:"qccombo"},{dataIndex:"qc_five_prime_lr_pcr_result",header:"Five Prime LR PCR",sortable:false,editor:"qccombo"},{dataIndex:"qc_five_prime_cassette_integrity_result",header:"Five Prime Cassette Integrity",sortable:false,editor:"qccombo"},{dataIndex:"qc_tv_backbone_assay_result",header:"TV Backbone Assay",sortable:false,editor:"qccombo"},{dataIndex:"qc_neo_count_qpcr_result",header:"Neo Count QPCR",sortable:false,editor:"qccombo"},{dataIndex:"qc_neo_sr_pcr_result",header:"Neo SR PCR",sortable:false,editor:"qccombo"},{dataIndex:"qc_loa_qpcr_result",header:"LOA QPCR",sortable:false,editor:"qccombo"},{dataIndex:"qc_homozygous_loa_sr_pcr_result",header:"Homozygous LOA SR PCR",sortable:false,editor:"qccombo"},{dataIndex:"qc_lacz_sr_pcr_result",header:"LacZ SR PCR",sortable:false,editor:"qccombo"},{dataIndex:"qc_mutant_specific_sr_pcr_result",header:"Mutant Specific SR PCR",sortable:false,editor:"qccombo"},{dataIndex:"qc_loxp_confirmation_result",header:"LoxP Confirmation",sortable:false,editor:"qccombo"},{dataIndex:"qc_three_prime_lr_pcr_result",header:"Three Prime LR PCR",sortable:false,editor:"qccombo"},{dataIndex:"report_to_public",header:"Report to Public",xtype:"boolgridcolumn"},{dataIndex:"is_active",header:"Active?",xtype:"boolgridcolumn"},{dataIndex:"is_released_from_genotyping",header:"Released From Genotyping",xtype:"boolgridcolumn"}]},additionalViewColumns:{Summary:["emma_status","mouse_allele_type","mouse_allele_symbol"]}});Ext.define("Imits.widget.MiPlansGrid",{extend:"Imits.widget.Grid",requires:["Imits.model.MiPlan","Imits.widget.grid.RansackFiltersFeature","Imits.widget.MiPlanEditor"],title:"Plans",iconCls:"icon-grid",columnLines:true,store:{model:"Imits.model.MiPlan",autoLoad:true,remoteSort:true,remoteFilter:true,pageSize:20},selType:"rowmodel",features:[{ftype:"ransack_filters",local:false}],initComponent:function(){var a=this;a.callParent();a.addDocked(Ext.create("Ext.toolbar.Paging",{store:a.getStore(),dock:"bottom",displayInfo:true}));a.miPlanEditor=Ext.create("Imits.widget.MiPlanEditor",{listeners:{hide:{fn:function(){a.reloadStore();a.setLoading(false)}}}});a.addListener("itemclick",function(b,g,f,c,e,d){var i=Ext.get(e.getTarget());if(i.dom.nodeName.toLowerCase()!=="a"){var h=g.data.id;a.setLoading("Editing plan....");a.miPlanEditor.edit(h)}});a.addListener("afterrender",function(){a.filters.createFilters();if(window.CAN_SEE_SUB_PROJECT){var b=Ext.Array.filter(a.columns,function(d){return d.dataIndex==="sub_project_name"})[0];b.setVisible(true);var c=Ext.Array.filter(a.columns,function(d){return d.dataIndex==="is_bespoke_allele"})[0];c.setVisible(true)}})},columns:[{dataIndex:"id",header:"ID",readOnly:true,hidden:true},{header:"Edit In Form",dataIndex:"edit_link",renderer:function(c,b,a){var d=a.getId();return Ext.String.format('<a href="{0}/mi_plans/{1}">Edit in Form</a>',window.basePath,d)},sortable:false},{dataIndex:"marker_symbol",header:"Marker Symbol",readOnly:true,filter:{type:"string"}},{dataIndex:"consortium_name",header:"Consortium",readOnly:true,width:100,filter:{type:"list",options:window.CONSORTIUM_OPTIONS}},{dataIndex:"production_centre_name",header:"Production Centre",readOnly:true,width:115,filter:{type:"list",options:window.CENTRE_OPTIONS,value:window.USER_PRODUCTION_CENTRE}},{dataIndex:"status_name",header:"Status",readOnly:true,flex:1,filter:{type:"list",options:window.STATUS_OPTIONS}},{dataIndex:"priority_name",header:"Priority",readOnly:true,width:80,filter:{type:"list",options:window.PRIORITY_OPTIONS}},{dataIndex:"is_conditional_allele",header:"Conditional",xtype:"boolgridcolumn",width:60,readOnly:true},{dataIndex:"is_deletion_allele",header:"Deletion",xtype:"boolgridcolumn",width:60,readOnly:true},{dataIndex:"is_cre_knock_in_allele",header:"Cre Knock-in",xtype:"boolgridcolumn",width:60,readOnly:true},{dataIndex:"is_cre_bac_allele",header:"Cre BAC",xtype:"boolgridcolumn",width:60,readOnly:true},{dataIndex:"is_bespoke_allele",header:"Bespoke",xtype:"boolgridcolumn",width:60,readOnly:true,hidden:true},{dataIndex:"sub_project_name",header:"Sub-Project",readOnly:true,width:120,filter:{type:"list",options:window.SUB_PROJECT_OPTIONS},hidden:true}]});Ext.define("Imits.widget.grid.PhenotypeAttemptRansackFiltersFeature",{extend:"Imits.widget.grid.RansackFiltersFeature",alias:"feature.phenotype_attempt_ransack_filters",encode:false,buildQuery:function(a){var c=this.callParent([a]);var b=window.PHENOTYPE_ATTEMPT_SEARCH_PARAMS.terms;if(!Ext.isEmpty(b)){b=b.split("\n");c["q[marker_symbol_ci_in][]"]=b}return c}});function splitString(a){var b=[];Ext.Array.each(a.split(", "),function(c){b.push({distributionCentre:c})});return b}Ext.define("Imits.widget.PhenotypeAttemptsGrid",{extend:"Imits.widget.Grid",requires:["Imits.model.PhenotypeAttempt","Imits.widget.SimpleNumberField","Imits.widget.grid.PhenotypeAttemptRansackFiltersFeature","Imits.widget.grid.BoolGridColumn","Imits.Util"],title:"Phenotype attempts",iconCls:"icon-grid",columnLines:true,store:{model:"Imits.model.PhenotypeAttempt",autoLoad:true,remoteSort:true,remoteFilter:true,pageSize:20},selType:"rowmodel",features:[{ftype:"phenotype_attempt_ransack_filters",local:false}],initComponent:function(){var a=this;a.callParent();a.addDocked(Ext.create("Ext.toolbar.Paging",{store:a.getStore(),dock:"bottom",displayInfo:true}));a.addListener("afterrender",function(){a.filters.createFilters()})},columns:[{dataIndex:"id",header:"ID",readOnly:true,hidden:(Imits.Util.extractValueIfExistent(window.PHENOTYPE_ATTEMPT_SEARCH_PARAMS,"phenotype_attempt_id")?false:true),filter:{type:"string",value:Imits.Util.extractValueIfExistent(window.PHENOTYPE_ATTEMPT_SEARCH_PARAMS,"phenotype_attempt_id")}},{header:"Edit In Form",dataIndex:"edit_link",renderer:function(d,c,b){var a=b.getId();return Ext.String.format('<a href="{0}/phenotype_attempts/{1}">Edit in Form</a>',window.basePath,a)},sortable:false},{dataIndex:"colony_name",header:"Colony Name",editor:"textfield",filter:{type:"string"}},{dataIndex:"consortium_name",header:"Consortium",readOnly:true,width:115,filter:{type:"list",options:window.CONSORTIUM_OPTIONS,value:Imits.Util.extractValueIfExistent(window.PHENOTYPE_ATTEMPT_SEARCH_PARAMS,"consortium_name")},sortable:false},{dataIndex:"production_centre_name",header:"Production Centre",readOnly:true,width:150,filter:{type:"list",options:window.CENTRE_OPTIONS,value:Imits.Util.extractValueIfExistent(window.PHENOTYPE_ATTEMPT_SEARCH_PARAMS,"production_centre_name")},sortable:false},{header:"Distribution Centres",dataIndex:"distribution_centres_formatted_display",readOnly:true,sortable:false,width:225,renderer:function(e,c,b){var a=b.getId();var d=b.get("distribution_centres_formatted_display");if(d!=""){return Ext.String.format('<a href="{0}/phenotype_attempts/{1}#distribution_centres" target="_blank">{2}</a>',window.basePath,a,d)}else{return Ext.String.format("{0}",d)}}},{dataIndex:"marker_symbol",header:"Marker Symbol",readOnly:true,filter:{type:"string",value:Imits.Util.extractValueIfExistent(window.PHENOTYPE_ATTEMPT_SEARCH_PARAMS,"es_cell_marker_symbol")}},{dataIndex:"is_active",header:"Active?",readOnly:true,width:55,xtype:"boolgridcolumn",filter:{type:"boolean"}},{dataIndex:"status_name",header:"Status",readOnly:true,filter:{type:"list",options:window.PHENOTYPE_STATUS_OPTIONS}},{dataIndex:"rederivation_started",header:"Rederivation started",readOnly:true,xtype:"boolgridcolumn",width:115,filter:{type:"boolean"}},{dataIndex:"rederivation_complete",header:"Rederivation complete",readOnly:true,xtype:"boolgridcolumn",width:120,filter:{type:"boolean"}},{dataIndex:"deleter_strain_name",header:"Cre-deleter strain",readOnly:true,filter:{type:"list",options:window.PHENOTYPE_DELETER_STRAIN_OPTIONS}},{dataIndex:"number_of_cre_matings_successful",header:"# Cre Matings successful",readOnly:true,editor:"simplenumberfield",width:140},{dataIndex:"phenotyping_started",header:"Phenotyping Started",readOnly:true,xtype:"boolgridcolumn",width:115,filter:{type:"boolean"}},{dataIndex:"phenotyping_complete",header:"Phenotyping Complete",readOnly:true,xtype:"boolgridcolumn",width:120,filter:{type:"boolean"}}]});Ext.define("Imits.widget.SolrUpdateQueueItemsGrid",{extend:"Imits.widget.Grid",requires:["Imits.widget.grid.RansackFiltersFeature","Imits.model.SolrUpdateQueueItem","Imits.Util"],title:"Solr Update Queue Items",iconCls:"icon-grid",columnLines:true,store:{model:"Imits.model.SolrUpdateQueueItem",autoLoad:true,remoteSort:true,remoteFilter:true,pageSize:200},features:[{ftype:"ransack_filters",local:false}],initComponent:function(){var a=this;a.callParent();a.addDocked(Ext.create("Ext.toolbar.Paging",{store:a.getStore(),dock:"bottom",displayInfo:true}))},columns:[{dataIndex:"id",header:"ID",readOnly:true,width:60},{dataIndex:"reference",header:"Reference",readOnly:true,flex:1,renderer:function(f,e,d){var c=d.get("reference");if(c.type=="allele"){var a=Ext.String.format("{0}/{1}s/{2}",document.location.pathname.replace(/solr_update\/queue\/items/,"targ_rep"),c.type,c.id)}else{var a=Ext.String.format("{0}/{1}s/{2}",window.basePath,c.type,c.id)}var b=a+"/history";return Ext.String.format('<a href="{0}">{1} / {2}</a> (<a href="{3}">audit history</a>)',a,c.type,c.id,b)}},{dataIndex:"action",header:"Action",readOnly:true,width:60,filter:{type:"list",options:["update","delete"]}},{dataIndex:"created_at",xtype:"datecolumn",format:"d-m-Y H:i:s",header:"Created At",readOnly:true,width:125},{header:"",xtype:"actioncolumn",width:48,items:[{icon:window.basePath+"/images/icons/resultset_next.png",tooltip:"Run now",handler:function(b,e,a){var c=b.getStore().getAt(e);var d=c.get("id");Ext.Msg.confirm("Run item?","Run item "+d+"?",function(f){if(f==="yes"){b.setLoading("Running item "+d);Ext.Ajax.request({method:"POST",params:{authenticity_token:window.authenticityToken},url:window.basePath+"/solr_update/queue/items/"+d+"/run.json",success:function(){b.getStore().remove(c)},failure:function(g){Imits.Util.handleErrorResponse(g)},callback:function(){b.setLoading(false)}})}})}},{icon:window.basePath+"/images/icons/cancel.png",tooltip:"Delete",handler:function(b,d,a){var c=b.getStore().getAt(d);Ext.Msg.confirm("Delete item?","Delete item "+c.get("id")+"?",function(e){if(e==="yes"){b.setLoading("Deleting item "+c.get("id"));c.destroy({success:function(){b.getStore().remove(c)},callback:function(){b.setLoading(false)}})}})}}]},{header:"",width:80,renderer:function(d,c,b){var a=b.get("reference");return Ext.String.format('<a href="{0}/search?q=type:{1}+id:{2}">{3}</a>',window.SOLR_ALLELE_URL,a.type,a.id,"SOLR view")}}]});Ext.define("Imits.widget.GeneRelationshipTree",{extend:"Ext.tree.Panel",requires:["Ext.data.TreeStore","Ext.tree.plugin.TreeViewDragDrop"],mixins:["Imits.widget.ManageResizeWithBrowserFrame"],viewConfig:{plugins:{ptype:"treeviewdragdrop"}},columns:[{xtype:"treecolumn",dataIndex:"name",text:"&nbsp;",flex:1},{text:"ID",dataIndex:"id",hidden:true},{text:"Status",dataIndex:"status",width:200},{text:"Colony name",dataIndex:"colony_name",width:200},{text:"Sub-project",dataIndex:"sub_project_name",width:200}],handleMove:function(f,c,a){var b=this,e=a.data;if(e.type!=="MiPlan"){Ext.MessageBox.alert("Alert",Ext.String.format("Can only drag onto a Plan"))}else{if(e.id===f.data.mi_plan_id){Ext.MessageBox.alert("Alert",Ext.String.format("This {0} already belongs to {1} and {2}",f.data.name,e.consortium_name,e.production_centre_name))}else{var d=Ext.String.format("Updating {0} {1}<br>Old consortium / production centre / plan ID: {2} / {3} / {4}<br>New consortium / production centre / plan ID: {5} / {6} / {7}<br>",f.data.name,f.data.colony_name,f.data.consortium_name,f.data.production_centre_name,f.data.mi_plan_id,e.consortium_name,e.production_centre_name,e.id);Ext.MessageBox.confirm("Note",d,function(h){if(h==="yes"){var g;if(f.data.type==="MiAttempt"){g=Imits.model.MiAttempt}else{if(f.data.type==="PhenotypeAttempt"){g=Imits.model.PhenotypeAttempt}else{throw ("Unknown model")}}g.load(f.data.id,{success:function(i){i.set("mi_plan_id",e.id);i.save({success:function(){b.getStore().reload()}})}})}})}}},initComponent:function(){var a=this;a.callParent();a.addListener("load",function(c,b,d){if(d){a.expandAll()}});a.addListener("beforeitemmove",function(e,d,b,c){if(["MiPlan","Centre","Consortium"].indexOf(b.data.type)!==-1){a.handleMove(e,d,b)}return false})},title:"&nbsp;",store:Ext.create("Ext.data.TreeStore",{fields:[{name:"id",type:"integer"},{name:"mi_plan_id",type:"integer"},{name:"name",type:"string"},{name:"type",type:"string"},{name:"status",type:"string"},{name:"colony_name",type:"string"},{name:"consortium_name",type:"string"},{name:"production_centre_name",type:"string"},{name:"sub_project_name",type:"string"}],proxy:{type:"ajax",url:(function(){if(window.GENE){return window.basePath+"/genes/"+window.GENE.mgi_accession_id+"/relationship_tree.json"}else{return""}}())}}),rootVisible:false,useArrows:true});Ext.define("Imits.widget.ContactsGrid",{extend:"Imits.widget.Grid",requires:["Imits.model.Contact","Imits.widget.grid.RansackFiltersFeature","Imits.Util"],title:"Contacts",iconCls:"icon-grid",columnLines:true,store:{model:"Imits.model.Contact",autoLoad:true,autoSync:true,remoteSort:true,remoteFilter:true,pageSize:20},selType:"rowmodel",features:[{ftype:"ransack_filters",local:false}],plugins:[Ext.create("Ext.grid.plugin.RowEditing",{autoCancel:false,clicksToEdit:1})],initComponent:function(){var a=this;a.callParent();a.addDocked(Ext.create("Ext.toolbar.Paging",{store:a.getStore(),dock:"bottom",displayInfo:true}))},columns:[{dataIndex:"id",header:"ID",readOnly:true,hidden:true},{dataIndex:"email",header:"Email address",width:300,filter:{type:"string"},editor:"textfield"},{xtype:"actioncolumn",width:21,items:[{icon:"../images/icons/delete.png",tooltip:"Delete",handler:function(b,d,a){var c=b.getStore().getAt(d);if(confirm("Remove contact?")){b.getStore().removeAt(d)}}}]}]});Ext.define("Imits.widget.NotificationPane",{extend:"Imits.widget.Window",requires:["Imits.model.Notification"],title:"View Notification",resizable:true,layout:"fit",closeAction:"hide",cls:"notification view",constructor:function(a){return this.callParent([a])},initComponent:function(){var a=this;this.callParent();this.form=Ext.create("Ext.form.Panel",{ui:"plain",margin:"0 0 10 0",width:600,layout:"anchor",defaults:{anchor:"100%",labelWidth:150,labelAlign:"right",labelPad:10},items:[{id:"welcome_email",xtype:"textarea",fieldLabel:"Welcome email",name:"welcome_email",height:230,readOnly:true},{id:"last_email",xtype:"textarea",fieldLabel:"Last email",name:"last_email",height:230,readOnly:true}],buttons:[{text:"Cancel",handler:function(){a.hide()}}]});var b=520;this.add(Ext.create("Ext.panel.Panel",{height:b,ui:"plain",layout:{type:"vbox",align:"stretchmax"},padding:5,items:[a.form]}));this.fields=this.form.items.keys},load:function(b){var a=this;Imits.model.Notification.load(b,{success:function(c){a.notification=c;Ext.each(a.fields,function(d){var e=a.form.getComponent(d);if(e){e.setValue(a.notification.get(d))}});a.show()}})},});Ext.define("Imits.widget.NotificationsGrid",{extend:"Imits.widget.Grid",requires:["Imits.model.Notification","Imits.widget.NotificationPane","Imits.widget.grid.RansackFiltersFeature","Imits.Util"],title:"Notifications",iconCls:"icon-grid",columnLines:true,store:{model:"Imits.model.Notification",autoLoad:true,remoteSort:true,remoteFilter:true,pageSize:20},selType:"rowmodel",features:[{ftype:"ransack_filters",local:false}],createNotification:function(){var b=this;var a=b.emailField.getSubmitValue();var d=b.geneField.getSubmitValue();if(!a||a&&!a.length){alert("You must enter a Email Address.");return}if(!d||d&&!d.length){alert("You must enter a gene marker symbol.");return}b.setLoading(true);var c=Ext.create("Imits.model.Notification",{contact_email:a,gene_marker_symbol:d});c.save({callback:function(){b.reloadStore();b.setLoading(false);b.geneField.setValue();b.emailField.setValue()}})},initComponent:function(){var a=this;a.callParent();a.addDocked(Ext.create("Ext.toolbar.Paging",{store:a.getStore(),dock:"bottom",displayInfo:true}));a.notificationPane=Ext.create("Imits.widget.NotificationPane",{listeners:{hide:{fn:function(){a.setLoading(false)}}}});a.getView().on("cellmousedown",function(d,b,g,f,h,c,e){var i=f.data.id;a.setLoading("Loading notification....");a.notificationPane.load(i)});a.geneField=Ext.create("Ext.form.field.ComboBox",{displayField:"gene_name",store:window.GENE_OPTIONS,fieldLabel:"Gene of interest",labelAlign:"right",labelWidth:100,queryMode:"local",typeAhead:true});a.emailField=Ext.create("Ext.form.field.Text",{fieldLabel:"Email address",name:"email",labelWidth:80,width:250,labelAlign:"right"});a.addDocked(Ext.create("Ext.toolbar.Toolbar",{dock:"top",items:[a.geneField,a.emailField,"  ",{id:"register_interest_button",text:"Register interest",cls:"x-btn-text-icon",iconCls:"icon-add",grid:a,handler:function(){a.createNotification()}}]}))},columns:[{dataIndex:"id",header:"ID",readOnly:true,hidden:true},{dataIndex:"gene_id",header:"Gene ID",hidden:true},{dataIndex:"gene_marker_symbol",header:"Gene",filter:{type:"string"}},{dataIndex:"contact_id",header:"Contact ID",hidden:true},{dataIndex:"contact_email",header:"Contact",width:180,filter:{type:"string"}},{dataIndex:"last_email_sent",xtype:"datecolumn",format:"Y-m-d H:i:s",header:"Last email sent",width:130},{dataIndex:"welcome_email_sent",xtype:"datecolumn",format:"Y-m-d H:i:s",header:"Welcome email sent",width:130},{dataIndex:"updated_at",xtype:"datecolumn",format:"Y-m-d H:i:s",header:"Last updated",hidden:true,width:130},{xtype:"actioncolumn",width:21,items:[{icon:"../images/icons/time_go.png",tooltip:"Resend",handler:function(b,e,a){var c=b.getStore().getAt(e);var d=c.data.id;if(confirm("Are you sure you want to resend this notification?")){Ext.Ajax.request({url:document.location.pathname+"/"+d+"/retry.json",method:"PUT",params:{authenticity_token:window.authenticityToken},success:function(f){var g=f.responseText}})}}}]}]});Ext.define("Imits.widget.ProductionGoalsGrid",{extend:"Imits.widget.Grid",requires:["Imits.model.ProductionGoal","Imits.widget.grid.RansackFiltersFeature","Imits.Util"],title:"Production Goals",iconCls:"icon-grid",columnLines:true,store:{model:"Imits.model.ProductionGoal",autoLoad:true,autoSync:true,remoteSort:true,remoteFilter:true,},selType:"rowmodel",features:[{ftype:"ransack_filters",local:false}],plugins:[Ext.create("Ext.grid.plugin.RowEditing",{autoCancel:false,clicksToEdit:1})],createProductionGoal:function(){var a=this;var e=a.consortiumCombo.getSubmitValue();var d=a.yearText.getSubmitValue();var c=a.monthText.getSubmitValue();var f=a.miText.getSubmitValue();var g=a.gcText.getSubmitValue();if(!e||e&&!e.length){alert("You must enter a valid Consortium.");return}if(!d.length||d.length&&(d<2010||d>2050)){alert("You must enter a valid year.");return}if(c.length&&(c<1||c>12)){alert("You must enter a valid month.");return}if(!f.length||!g){alert("You must enter correct production goal values.");return}a.setLoading(true);var b=Ext.create("Imits.model.ProductionGoal",{consortium_name:e,year:d,month:c,mi_goal:f,gc_goal:g});b.save({callback:function(){a.reloadStore();a.setLoading(false);a.consortiumCombo.setValue();a.yearText.setValue();a.monthText.setValue();a.miText.setValue();a.gcText.setValue()}})},initComponent:function(){var a=this;a.callParent();a.addDocked(Ext.create("Ext.toolbar.Paging",{store:a.getStore(),dock:"bottom",displayInfo:true}));a.consortiumCombo=Ext.create("Imits.widget.SimpleCombo",{id:"consortiumCombobox",store:window.CONSORTIUM_OPTIONS,fieldLabel:"Consortium",labelAlign:"right",labelWidth:65,storeOptionsAreSpecial:true,hidden:false});a.yearText=Ext.create("Ext.form.field.Number",{fieldLabel:"Year",name:"year",labelWidth:50,labelAlign:"right",regex:/[1-9-]*/});a.monthText=Ext.create("Ext.form.field.Number",{fieldLabel:"Month",name:"month",labelWidth:50,labelAlign:"right",regex:/[1-9-]*/});a.miText=Ext.create("Ext.form.field.Number",{fieldLabel:"MI Goal",name:"mi_goal",labelWidth:50,labelAlign:"right",regex:/[1-9-]*/});a.gcText=Ext.create("Ext.form.field.Number",{fieldLabel:"GC Goal",name:"gc_goal",labelWidth:50,labelAlign:"right",regex:/[1-9-]*/});a.addDocked(Ext.create("Ext.toolbar.Toolbar",{dock:"top",items:[a.consortiumCombo,a.yearText,a.monthText,a.miText,a.gcText,"  ",{id:"register_interest_button",text:"Create production goal",cls:"x-btn-text-icon",iconCls:"icon-add",grid:a,handler:function(){a.createProductionGoal()}}]}))},columns:[{dataIndex:"id",header:"ID",readOnly:true,hidden:true},{dataIndex:"consortium_name",header:"Consortium",editor:{xtype:"simplecombo",store:Ext.Array.merge([""],window.CONSORTIUM_OPTIONS),storeOptionsAreSpecial:true,listConfig:{minWidth:200}},filter:{type:"list",options:window.CONSORTIUM_OPTIONS}},{dataIndex:"year",header:"Year",editor:"simplenumberfield"},{dataIndex:"month",header:"Month",editor:"simplenumberfield"},{dataIndex:"mi_goal",header:"MI Goal",editor:"simplenumberfield"},{dataIndex:"gc_goal",header:"GC Goal",editor:"simplenumberfield"},{xtype:"actioncolumn",width:21,items:[{icon:"images/icons/delete.png",tooltip:"Delete",handler:function(b,d,a){var c=b.getStore().getAt(d);if(confirm("Remove production goal?")){b.getStore().removeAt(d)}}}]},{header:"History",dataIndex:"edit_link",renderer:function(d,c,b){var a=b.getId();return Ext.String.format('<a href="{0}/production_goals/{1}/history">View history</a>',window.basePath,a)},sortable:false}]});