NO_BREAK_SPACE="\u00A0";(function(){var a=Date.parse;Date.parse=function(c){var d=a(c);if(!isNaN(d)){return d}var b=/(\d{4})-(\d{2})-(\d{2})/.exec(c);if(b){d=Date.UTC(+b[1],+b[2]-1,+b[3])}return d}}());function setInitialFocus(){var a=Ext.select(".initial-focus").first();if(a){a.focus()}}Ext.onReady(setInitialFocus);function initDisableOnSubmitButtons(){Ext.select(".disable-on-submit").each(function(a){a.addListener("click",function(){a.set({disabled:"disabled"});var b=a.up("form");b.dom.submit()})})}Ext.onReady(initDisableOnSubmitButtons);function toggleCollapsibleFieldsetLegend(b){var a=b.up("fieldset");var c=a.down("div");c.setVisibilityMode(Ext.Element.DISPLAY);c.toggle();a.toggleCls("collapsible-content-hidden");a.toggleCls("collapsible-content-shown")}function setupCollapsibleFieldsets(){var a=Ext.select("fieldset.collapsible > legend");a.addCls("collapsible-control");a.each(function(d,c,b){d.addListener("click",function(){toggleCollapsibleFieldsetLegend(Ext.get(c.elements[b]))});d.up("fieldset").addCls("collapsible-content-shown")})}Ext.onReady(setupCollapsibleFieldsets);function hideDefaultCollapsibleFieldsets(){Ext.select("fieldset.collapsible.hide-by-default legend").each(function(c,b,a){toggleCollapsibleFieldsetLegend(Ext.get(b.elements[a]))})}Ext.onReady(hideDefaultCollapsibleFieldsets);Ext.util.Format.safeTextRenderer=function(a){if(Ext.isEmpty(a)){a=window.NO_BREAK_SPACE}else{a=String(a)}return Ext.util.Format.htmlEncode(a)};Ext.Loader.setConfig({enabled:true,paths:{Imits:window.basePath+"/javascripts/Imits"}});Ext.onReady(function(){function a(){}var b=[Ext.versions.core.major,Ext.versions.core.minor,Ext.versions.core.patch];if(b[0]!=4||b[1]!=0){return}if(b[2]<=7){a()}});Ext.define("Imits.data.JsonWriter",{extend:"Ext.data.writer.Json",writeAllFields:false,write:function(a){var b=this.callParent([a]);b.params.authenticity_token=window.authenticityToken;if(b.jsonData[this.root]&&b.jsonData[this.root]["id"]){delete b.jsonData[this.root]["id"]}if(b.action==="destroy"&&!Ext.isEmpty(b.params)){b.url=Ext.urlAppend(b.url,Ext.urlEncode(b.params));b.jsonData=null;b.params=null}return b}});Ext.define("Imits.data.JsonReader",{extend:"Ext.data.reader.Json",alias:null,readRecords:function(a){if(!this.getRoot(a)&&!Ext.isEmpty(a.id)){a=[a]}return this.callParent([a])},getResponseData:function(a){if(a.request.options.method=="DELETE"&&a.status==200){return{}}else{return this.callParent([a])}}});Ext.define("Imits.data.Proxy",{extend:"Ext.data.proxy.Rest",requires:["Imits.data.JsonWriter","Imits.data.JsonReader"],constructor:function(a){var b=a.resource;this.callParent([{format:"json",url:window.basePath+"/"+b+"s",extraParams:{extended_response:true},startParam:undefined,limitParam:"per_page",sortParam:"sorts",reader:Ext.create("Imits.data.JsonReader",{root:b+"s"}),writer:Ext.create("Imits.data.JsonWriter",{root:b,writeAllFields:false}),listeners:{exception:function(e,d,c){var g=Ext.JSON.decode(d.responseText);var f=function(){var h=[];Ext.Object.each(g,function(j,i){var k=Ext.String.capitalize(j).replace(/_/g," ")+": ";if(Ext.isString(i)){k+=i}else{if(Ext.isArray){k+=i.join(", ")}}h.push(k)});return h.join("<br/>")};Ext.MessageBox.show({title:"Error",msg:f(g),icon:Ext.MessageBox.ERROR,buttons:Ext.Msg.OK,fn:function(h,j,i){console.log("TODO: Refresh the cell/row that was changed")}})}},encodeSorters:function(c){if(c.length===0){return""}else{var d=c[0];return d.property+" "+d.direction.toLowerCase()}}}])}});Ext.define("Imits.model.MiPlan",{extend:"Ext.data.Model",requires:["Imits.data.Proxy"],fields:[{name:"id",type:"int",persist:false},{name:"marker_symbol"},{name:"consortium_name"},{name:"production_centre_name"},{name:"status_name"},{name:"priority_name"},{name:"sub_project_name"},{name:"number_of_es_cells_starting_qc"},{name:"number_of_es_cells_passing_qc"},{name:"withdrawn",defaultValue:false},{name:"is_active",defaultValue:true},{name:"is_bespoke_allele",defaultValue:false}],proxy:Ext.create("Imits.data.Proxy",{resource:"mi_plan"})});Ext.define("Imits.model.MiAttempt",{extend:"Ext.data.Model",requires:["Imits.data.Proxy"],fields:[{name:"id",type:"int",persist:false},{name:"es_cell_name",persist:false},{name:"es_cell_marker_symbol",persist:false},{name:"es_cell_allele_symbol",persist:false},{name:"mi_date",type:"date"},{name:"status_name",persist:false},"colony_name",{name:"consortium_name",persist:false},{name:"production_centre_name",persist:false},"distribution_centre_name","deposited_material_name","blast_strain_name",{name:"total_blasts_injected",type:"int"},{name:"total_transferred",type:"int"},{name:"number_surrogates_receiving",type:"int"},{name:"total_pups_born",type:"int"},{name:"total_female_chimeras",type:"int"},{name:"total_male_chimeras",type:"int"},{name:"total_chimeras",type:"int",persist:false},{name:"number_of_males_with_0_to_39_percent_chimerism",type:"int"},{name:"number_of_males_with_40_to_79_percent_chimerism",type:"int"},{name:"number_of_males_with_80_to_99_percent_chimerism",type:"int"},{name:"number_of_males_with_100_percent_chimerism",type:"int"},{name:"emma_status"},{name:"test_cross_strain_name"},{name:"colony_background_strain_name"},{name:"date_chimeras_mated",type:"date"},{name:"number_of_chimera_matings_attempted",type:"int"},{name:"number_of_chimera_matings_successful",type:"int"},{name:"number_of_chimeras_with_glt_from_cct",type:"int"},{name:"number_of_chimeras_with_glt_from_genotyping",type:"int"},{name:"number_of_chimeras_with_0_to_9_percent_glt",type:"int"},{name:"number_of_chimeras_with_10_to_49_percent_glt",type:"int"},{name:"number_of_chimeras_with_50_to_99_percent_glt",type:"int"},{name:"number_of_chimeras_with_100_percent_glt",type:"int"},{name:"total_f1_mice_from_matings",type:"int"},{name:"number_of_cct_offspring",type:"int"},{name:"number_of_het_offspring",type:"int"},{name:"number_of_live_glt_offspring",type:"int"},{name:"mouse_allele_type",readOnly:true},{name:"mouse_allele_symbol",readOnly:true},"qc_southern_blot_result","qc_five_prime_lr_pcr_result","qc_five_prime_cassette_integrity_result","qc_tv_backbone_assay_result","qc_neo_count_qpcr_result","qc_neo_sr_pcr_result","qc_loa_qpcr_result","qc_homozygous_loa_sr_pcr_result","qc_lacz_sr_pcr_result","qc_mutant_specific_sr_pcr_result","qc_loxp_confirmation_result","qc_three_prime_lr_pcr_result",{name:"report_to_public",type:"boolean"},{name:"is_active",type:"boolean"},{name:"is_released_from_genotyping",type:"boolean"}],proxy:Ext.create("Imits.data.Proxy",{resource:"mi_attempt"})});Ext.define("Imits.model.PhenotypeAttempt",{extend:"Ext.data.Model",requires:["Imits.data.Proxy"],fields:[{name:"id",type:"int",persist:false},{name:"colony_name"},{name:"consortium_name"},{name:"production_centre_name"},{name:"mi_attempt_colony_name",readOnly:true,persist:false},{name:"marker_symbol"},{name:"is_active"},{name:"status_name",persist:false,readOnly:true},{name:"rederivation_started"},{name:"rederivation_complete"},{name:"number_of_cre_matings_started"},{name:"number_of_cre_matings_successful"},{name:"phenotyping_started"},{name:"phenotyping_complete"}],proxy:Ext.create("Imits.data.Proxy",{resource:"phenotype_attempt"})});Ext.define("Imits.model.Gene",{extend:"Ext.data.Model",requires:["Imits.data.Proxy"],fields:[{name:"id",type:"int",readOnly:true},{name:"marker_symbol",readOnly:true},{name:"mgi_accession_id",readOnly:true},{name:"ikmc_projects_count",readOnly:true},{name:"pretty_print_types_of_cells_available",readOnly:true},{name:"non_assigned_mi_plans",readOnly:true},{name:"assigned_mi_plans",readOnly:true},{name:"pretty_print_aborted_mi_attempts",readOnly:true},{name:"pretty_print_mi_attempts_in_progress",readOnly:true},{name:"pretty_print_mi_attempts_genotype_confirmed",readOnly:true},{name:"pretty_print_phenotype_attempts",readOnly:true}],proxy:Ext.create("Imits.data.Proxy",{resource:"gene"})});Ext.define("Imits.widget.Window",{extend:"Ext.window.Window",plain:true,showLoadMask:function(){this.loadMask=new Ext.LoadMask(this.getComponent(0).getEl());this.loadMask.show()},hideLoadMask:function(){this.loadMask.hide()}});Ext.define("Imits.widget.Grid",{extend:"Ext.grid.Panel",manageResize:function(){var b=window.innerHeight-30;if(!b){b=document.documentElement.clientHeight-30}var a=b-this.getEl().getTop();if(a<200){a=200}this.setHeight(a);this.setWidth(this.getEl().up("div").getWidth());this.doLayout()},reloadStore:function(){var a=this.getStore();a.sync();a.load()}});Ext.define("Imits.widget.SimpleNumberField",{extend:"Ext.form.field.Number",alias:"widget.simplenumberfield",minValue:0,hideTrigger:true,keyNavEnabled:false,mouseWheelEnabled:false,allowDecimals:false});Ext.define("Imits.widget.SimpleCheckbox",{extend:"Ext.form.field.Checkbox",alias:"widget.simplecheckbox",editor:{xtype:"checkbox",cls:"x-grid-checkheader-editor"},renderer:function(b){var a="x-grid-checkheader";if(b===true){a+=" x-grid-checkheader-checked"}return'<div class="'+a+'"></div>'},filter:{type:"boolean",defaultValue:null}});Ext.define("Imits.widget.SimpleCombo",{extend:"Ext.form.field.ComboBox",alias:"widget.simplecombo",typeAhead:false,triggerAction:"all",forceSelection:true,editable:false,constructor:function(a){if(a.storeOptionsAreSpecial==true){var b=function(c){if(Ext.isEmpty(c)){return[c,window.NO_BREAK_SPACE]}else{return[c,Ext.String.htmlEncode(c)]}};a.store=Ext.Array.map(a.store,b)}this.callParent([a])},initComponent:function(){this.callParent();if(this.storeOptionsAreSpecial==true){this.displayTpl=Ext.create("Ext.XTemplate",'<tpl for=".">{[typeof values === "string" ? values : values["'+this.valueField+'"]]}<tpl if="xindex < xcount">'+this.delimiter+"</tpl></tpl>")}}});Ext.define("Imits.widget.QCCombo",{extend:"Imits.widget.SimpleCombo",alias:"widget.qccombo",store:window.MI_ATTEMPT_QC_OPTIONS});Ext.define("Imits.widget.grid.BoolGridColumn",{extend:"Ext.grid.Column",alias:"widget.boolgridcolumn",editor:{xtype:"checkbox",cls:"x-grid-checkheader-editor"},renderer:function(b){var a="x-grid-checkheader";if(b===true){a+=" x-grid-checkheader-checked"}return'<div class="'+a+'"></div>'},filter:{type:"boolean",defaultValue:null}});Ext.define("Imits.widget.grid.SimpleDateColumn",{extend:"Ext.grid.column.Date",alias:"widget.simpledatecolumn",format:"d-m-Y",editor:{xtype:"datefield",format:"d-m-Y"},filter:{type:"date"}});Ext.define("Imits.widget.grid.RansackFiltersFeature",{extend:"Ext.ux.grid.FiltersFeature",alias:"feature.ransack_filters",encode:false,buildQuerySingle:function(b){var c={};switch(b.data.type){case"string":case"list":c["q["+b.field+"_ci_in][]"]=b.data.value;break;case"boolean":c["q["+b.field+"_eq]"]=b.data.value;break;case"date":var a=b.data.value.split("/");c["q["+b.field+"_"+b.data.comparison+"]"]=[a[2]+"-"+a[0]+"-"+a[1]];break}return c},buildQuery:function(b){var c={};var a=this;Ext.each(b,function(e){var f=a.buildQuerySingle(e);for(var d in f){c[d]=f[d]}});return c},cleanParams:function(c){var b,a;b=new RegExp("^q\\[\\w+_ci_in\\]$");for(a in c){if(b.test(a)){delete c[a]}}}});Ext.define("Imits.widget.grid.MiAttemptRansackFiltersFeature",{extend:"Imits.widget.grid.RansackFiltersFeature",alias:"feature.mi_attempt_ransack_filters",encode:false,constructor:function(b){this.callParent([b]);var c=window.MI_ATTEMPT_SEARCH_PARAMS.production_centre_name;var a=window.MI_ATTEMPT_SEARCH_PARAMS.status_name;if(!Ext.isEmpty(c)){this.addFilter({type:"string",dataIndex:"production_centre_name",value:c})}if(!Ext.isEmpty(a)){this.addFilter({type:"string",dataIndex:"status_name",value:a})}},buildQuery:function(b){var c=this.callParent([b]);var a=window.MI_ATTEMPT_SEARCH_PARAMS.terms;if(!Ext.isEmpty(a)){a=a.split("\n");c["q[es_cell_marker_symbol_or_es_cell_name_or_colony_name_ci_in][]"]=a}return c}});Ext.define("Imits.widget.grid.MiPlanRansackFiltersFeature",{extend:"Imits.widget.grid.RansackFiltersFeature",alias:"feature.mi_plan_ransack_filters",encode:false,constructor:function(a){this.callParent([a]);var b=window.USER_PRODUCTION_CENTRE;this.addFilter({type:"string",dataIndex:"production_centre_name",value:b})}});Ext.define("Imits.widget.MiGrid",{extend:"Imits.widget.Grid",requires:["Imits.model.MiAttempt","Imits.widget.SimpleNumberField","Imits.widget.SimpleCombo","Imits.widget.QCCombo","Imits.widget.grid.BoolGridColumn","Imits.widget.grid.MiAttemptRansackFiltersFeature","Imits.widget.grid.SimpleDateColumn"],title:"Micro-Injection Attempts",store:{model:"Imits.model.MiAttempt",autoLoad:true,autoSync:true,remoteSort:true,pageSize:20},selType:"rowmodel",plugins:[Ext.create("Ext.grid.plugin.RowEditing",{autoCancel:false,clicksToEdit:1})],features:[{ftype:"mi_attempt_ransack_filters",local:false}],generateColumns:function(a){var b=[];Ext.Object.each(this.groupedColumns,function(d,c){Ext.Array.each(c,function(e){var f;Ext.each(b,function(g){if(g.dataIndex==e.dataIndex&&g.header==e.header){f=g}});if(!f){e.tdCls="column-"+e.dataIndex;b.push(e)}})});a.columns=b},generateViews:function(){var a={};var d=Ext.pluck(this.groupedColumns.common,"dataIndex");var c=Ext.Array.merge(d,[]);Ext.Object.each(this.groupedColumns,function(g,e){if(g==="common"||g==="none"){return}var f=Ext.pluck(e,"dataIndex");a[g]=Ext.Array.merge(d,f);c=Ext.Array.merge(c,f)});a.Everything=c;var b=this;Ext.Object.each(this.additionalViewColumns,function(e){a[e]=Ext.Array.merge(d,b.additionalViewColumns[e])});this.views=a},constructor:function(a){if(a==undefined){a={}}this.generateColumns(a);this.generateViews();this.callParent([a])},switchViewButtonConfig:function(c,b){var a=this;return{text:c,enableToggle:true,allowDepress:false,toggleGroup:"mi_grid_view_config",minWidth:100,pressed:(b===true),listeners:{toggle:function(e,g){if(!g){return}function f(){var h=a.views[c];Ext.each(a.columns,function(i){if(Ext.Array.indexOf(h,i.dataIndex)==-1){i.setVisible(false)}else{i.setVisible(true)}});d.hide();Ext.getBody().removeCls("wait")}var d=new Ext.LoadMask(a.getEl(),{msg:"Please wait&hellip;",removeMask:true});Ext.getBody().addCls("wait");d.show();setTimeout(f,100)}}}},initComponent:function(){this.callParent();this.addDocked(Ext.create("Ext.toolbar.Paging",{store:this.getStore(),dock:"bottom",displayInfo:true}));this.addDocked(Ext.create("Ext.container.ButtonGroup",{layout:"hbox",dock:"top",items:[this.switchViewButtonConfig("Everything",true),this.switchViewButtonConfig("Transfer Details"),this.switchViewButtonConfig("Litter Details"),this.switchViewButtonConfig("Chimera Mating Details"),this.switchViewButtonConfig("QC Details"),this.switchViewButtonConfig("Summary")]}))},groupedColumns:{none:[{dataIndex:"id",header:"ID",readOnly:true,hidden:true}],common:[{header:"Edit In Form",dataIndex:"edit_link",renderer:function(d,b,a){var c=a.getId();return Ext.String.format('<a href="{0}/mi_attempts/{1}">Edit in Form</a>',window.basePath,c)},sortable:false},{header:"Phenotype",dataIndex:"phenotype_attempt_new_link",renderer:function(e,b,a){var d=a.getId();var c=a.get("status_name");if(c=="Genotype confirmed"){return Ext.String.format('<a href="{0}/mi_attempts/{1}/phenotype_attempts/new">Create</a>',window.basePath,d)}else{return Ext.String.format("",window.basePath,d)}},sortable:false},{dataIndex:"consortium_name",header:"Consortium",readOnly:true,width:115,filter:{type:"list",options:window.MI_ATTEMPT_CONSORTIUM_OPTIONS},sortable:false},{dataIndex:"production_centre_name",header:"Production Centre",readOnly:true,filter:{type:"list",options:window.MI_ATTEMPT_CENTRE_OPTIONS},sortable:false},{dataIndex:"es_cell_name",header:"ES Cell",readOnly:true,sortable:false,filter:{type:"string"}},{dataIndex:"es_cell_marker_symbol",header:"Marker Symbol",width:75,readOnly:true,sortable:false,filter:{type:"string"}},{dataIndex:"es_cell_allele_symbol",header:"Allele symbol",readOnly:true,sortable:false},{xtype:"simpledatecolumn",dataIndex:"mi_date",header:"MI Date"},{dataIndex:"status_name",header:"Status",width:150,readOnly:true,sortable:false,filter:{type:"list",options:window.MI_ATTEMPT_STATUS_OPTIONS}},{dataIndex:"colony_name",header:"Colony Name",editor:"textfield",filter:{type:"string"}},{dataIndex:"distribution_centre_name",header:"Distribution Centre",editor:{xtype:"simplecombo",store:window.MI_ATTEMPT_CENTRE_OPTIONS},filter:{type:"list",options:window.MI_ATTEMPT_CENTRE_OPTIONS}},{dataIndex:"deposited_material_name",header:"Deposited Material",editor:{xtype:"simplecombo",store:window.MI_ATTEMPT_DEPOSITED_MATERIAL_OPTIONS}}],"Transfer Details":[{dataIndex:"blast_strain_name",header:"Blast Strain",sortable:false,renderer:"safeTextRenderer",width:200,editor:{xtype:"simplecombo",store:Ext.Array.merge([""],window.MI_ATTEMPT_STRAIN_OPTIONS),storeOptionsAreSpecial:true,listConfig:{minWidth:200}}},{dataIndex:"total_blasts_injected",header:"Total Blasts Injected",editor:"simplenumberfield"},{dataIndex:"total_transferred",header:"Total Transferred",editor:"simplenumberfield"},{dataIndex:"number_surrogates_receiving",header:"# Surrogates Receiving",editor:"simplenumberfield"}],"Litter Details":[{dataIndex:"total_pups_born",header:"Total Pups Born",editor:"simplenumberfield"},{dataIndex:"total_female_chimeras",header:"Total Female Chimeras",editor:"simplenumberfield"},{dataIndex:"total_male_chimeras",header:"Total Male Chimeras",editor:"simplenumberfield"},{dataIndex:"total_chimeras",header:"Total Chimeras",readOnly:true},{dataIndex:"number_of_males_with_100_percent_chimerism",header:"100% Male Chimerism Levels",editor:"simplenumberfield"},{dataIndex:"number_of_males_with_80_to_99_percent_chimerism",header:"99-80% Male Chimerism Levels",editor:"simplenumberfield"},{dataIndex:"number_of_males_with_40_to_79_percent_chimerism",header:"79-40% Male Chimerism Levels",editor:"simplenumberfield"},{dataIndex:"number_of_males_with_0_to_39_percent_chimerism",header:"39-0% Male Chimerism Levels",editor:"simplenumberfield"}],"Chimera Mating Details":[{dataIndex:"emma_status",header:"EMMA Status",sortable:false,width:200,renderer:function(a){return MI_ATTEMPT_EMMA_OPTIONS[a]},editor:{xtype:"simplecombo",store:Ext.Array.map(Ext.Object.getKeys(window.MI_ATTEMPT_EMMA_OPTIONS),function(a){return[a,window.MI_ATTEMPT_EMMA_OPTIONS[a]]}),listConfig:{minWidth:200}}},{dataIndex:"test_cross_strain_name",header:"Test Cross Strain",readOnly:true,sortable:false,renderer:"safeTextRenderer",width:200,editor:{xtype:"simplecombo",store:Ext.Array.merge([""],window.MI_ATTEMPT_STRAIN_OPTIONS),storeOptionsAreSpecial:true,listConfig:{minWidth:200}}},{dataIndex:"colony_background_strain_name",header:"Colony Background Strain",readOnly:true,sortable:false,renderer:"safeTextRenderer",width:200,editor:{xtype:"simplecombo",store:Ext.Array.merge([""],window.MI_ATTEMPT_STRAIN_OPTIONS),storeOptionsAreSpecial:true,listConfig:{minWidth:200}}},{xtype:"simpledatecolumn",dataIndex:"date_chimeras_mated",header:"Date Chimeras Mated"},{dataIndex:"number_of_chimera_matings_attempted",header:"# Chimera Mating Attempted",editor:"simplenumberfield"},{dataIndex:"number_of_chimera_matings_successful",header:"# Chimera Matings Successful",editor:"simplenumberfield"},{dataIndex:"number_of_chimeras_with_glt_from_cct",header:"# Chimeras with Germline Transmission from CCT",editor:"simplenumberfield"},{dataIndex:"number_of_chimeras_with_glt_from_genotyping",header:"No. Chimeras with Germline Transmission from Genotyping",editor:"simplenumberfield"},{dataIndex:"number_of_chimeras_with_0_to_9_percent_glt",header:"# Chimeras with 0-9% GLT",editor:"simplenumberfield"},{dataIndex:"number_of_chimeras_with_10_to_49_percent_glt",header:"# Chimeras with 10-49% GLT",editor:"simplenumberfield"},{dataIndex:"number_of_chimeras_with_50_to_99_percent_glt",header:"No. Chimeras with 50-99% GLT",editor:"simplenumberfield"},{dataIndex:"number_of_chimeras_with_100_percent_glt",header:"No. Chimeras with 100% GLT",editor:"simplenumberfield"},{dataIndex:"total_f1_mice_from_matings",header:"Total F1 Mice from Matings",editor:"simplenumberfield"},{dataIndex:"number_of_cct_offspring",header:"# Coat Colour Transmission Offspring",editor:"simplenumberfield"},{dataIndex:"number_of_het_offspring",header:"# Het Offspring",editor:"simplenumberfield"},{dataIndex:"number_of_live_glt_offspring",header:"# Live GLT Offspring",editor:"simplenumberfield"},{dataIndex:"mouse_allele_type",header:"Mouse Allele Type",editor:{xtype:"simplecombo",store:window.MI_ATTEMPT_MOUSE_ALLELE_TYPE_OPTIONS,listConfig:{minWidth:300}}},{dataIndex:"mouse_allele_symbol",header:"Mouse Allele Symbol",readOnly:true}],"QC Details":[{dataIndex:"qc_southern_blot_result",header:"Southern Blot",sortable:false,editor:"qccombo"},{dataIndex:"qc_five_prime_lr_pcr_result",header:"Five Prime LR PCR",sortable:false,editor:"qccombo"},{dataIndex:"qc_five_prime_cassette_integrity_result",header:"Five Prime Cassette Integrity",sortable:false,editor:"qccombo"},{dataIndex:"qc_tv_backbone_assay_result",header:"TV Backbone Assay",sortable:false,editor:"qccombo"},{dataIndex:"qc_neo_count_qpcr_result",header:"Neo Count QPCR",sortable:false,editor:"qccombo"},{dataIndex:"qc_neo_sr_pcr_result",header:"Neo SR PCR",sortable:false,editor:"qccombo"},{dataIndex:"qc_loa_qpcr_result",header:"LOA QPCR",sortable:false,editor:"qccombo"},{dataIndex:"qc_homozygous_loa_sr_pcr_result",header:"Homozygous LOA SR PCR",sortable:false,editor:"qccombo"},{dataIndex:"qc_lacz_sr_pcr_result",header:"LacZ SR PCR",sortable:false,editor:"qccombo"},{dataIndex:"qc_mutant_specific_sr_pcr_result",header:"Mutant Specific SR PCR",sortable:false,editor:"qccombo"},{dataIndex:"qc_loxp_confirmation_result",header:"LoxP Confirmation",sortable:false,editor:"qccombo"},{dataIndex:"qc_three_prime_lr_pcr_result",header:"Three Prime LR PCR",sortable:false,editor:"qccombo"},{dataIndex:"report_to_public",header:"Report to Public",xtype:"boolgridcolumn"},{dataIndex:"is_active",header:"Active?",xtype:"boolgridcolumn"},{dataIndex:"is_released_from_genotyping",header:"Released From Genotyping",xtype:"boolgridcolumn"}]},additionalViewColumns:{Summary:["emma_status","mouse_allele_type","mouse_allele_symbol"]}});Ext.define("Imits.widget.MiPlanEditor",{extend:"Imits.widget.Window",requires:["Imits.model.MiPlan","Imits.widget.SimpleCombo","Imits.widget.SimpleCheckbox"],title:"Change Gene Interest",resizable:false,layout:"fit",closeAction:"hide",cls:"plan editor",constructor:function(a){if(Ext.isIE7||Ext.isIE8){a.width=400}return this.callParent([a])},initComponent:function(){var d=this;this.callParent();var b=true;if(window.CAN_SEE_SUB_PROJECT){b=false}this.form=Ext.create("Ext.form.Panel",{ui:"plain",margin:"0 0 10 0",width:360,layout:"anchor",defaults:{anchor:"100%",labelWidth:150,labelAlign:"right",labelPad:10},items:[{id:"marker_symbol",xtype:"textfield",fieldLabel:"Gene marker symbol",name:"marker_symbol",readOnly:true},{id:"consortium_name",xtype:"textfield",fieldLabel:"Consortium",name:"consortium_name",readOnly:true},{id:"production_centre_name",xtype:"simplecombo",fieldLabel:"Production Centre",name:"production_centre_name",storeOptionsAreSpecial:true,store:window.CENTRE_OPTIONS},{id:"status_name",xtype:"textfield",fieldLabel:"Status",name:"status_name",readOnly:true},{id:"priority_name",xtype:"simplecombo",fieldLabel:"Priority",name:"priority_name",store:window.PRIORITY_OPTIONS},{id:"is_bespoke_allele",xtype:"simplecheckbox",fieldLabel:"Bespoke allele?",name:"is_bespoke_allele",hidden:b},{id:"sub_project_name",xtype:"simplecombo",fieldLabel:"Sub-Project",name:"sub_project_name",storeOptionsAreSpecial:true,store:window.SUB_PROJECT_OPTIONS,hidden:b},{id:"number_of_es_cells_starting_qc",xtype:"simplenumberfield",fieldLabel:"# of ES Cells starting QC",name:"number_of_es_cells_starting_qc"},{id:"number_of_es_cells_passing_qc",xtype:"simplenumberfield",fieldLabel:"# of ES Cells passing QC",name:"number_of_es_cells_passing_qc"}],buttons:[{id:"update-button",text:"<strong>Update</strong>",handler:function(g){g.disable();var h=null;if(Ext.isEmpty(d.miPlan.get("number_of_es_cells_passing_qc"))&&!Ext.isEmpty(d.form.getComponent("number_of_es_cells_passing_qc").getValue())){if(d.form.getComponent("number_of_es_cells_passing_qc").getValue()==0){h='Saving these changes will force the status to "Aborted - ES Cell QC Failed"'}else{h='Saving these changes will force the status to "Assigned - ES Cell QC Complete"'}}else{if(Ext.isEmpty(d.miPlan.get("number_of_es_cells_starting_qc"))&&!Ext.isEmpty(d.form.getComponent("number_of_es_cells_starting_qc").getValue())){h='Saving these changes will force the status to "Assigned - ES Cell QC In Progress"'}}if(!Ext.isEmpty(h)){Ext.Msg.show({title:"Notice",msg:h+" - is that OK?",buttons:Ext.Msg.YESNO,icon:Ext.Msg.QUESTION,closable:false,fn:function(i){if(i==="yes"){d.updateAndHide()}else{g.enable()}}})}else{d.updateAndHide()}}},{text:"Cancel",handler:function(){d.hide()}}]});var e=Ext.create("Ext.panel.Panel",{ui:"plain",layout:{type:"hbox",align:"stretchmax"},margin:"0 0 10 0",items:[{xtype:"label",text:"Delete interest?",cls:"x-form-item-label",margin:"0 5 0 0"},{xtype:"button",id:"delete-button",text:"Delete",width:60,handler:function(g){g.hide();e.getComponent("delete-confirmation-button").show()}},{xtype:"button",id:"delete-confirmation-button",text:"Are you sure?",width:100,hidden:true,handler:function(g){d.setLoading(true);d.miPlan.destroy({success:function(){d.setLoading(false);d.hide()}});g.hide();e.getComponent("delete-button").show()}}]});var f=Ext.create("Ext.panel.Panel",{ui:"plain",layout:{type:"hbox",align:"stretchmax"},margin:"0 0 10 0",items:[{xtype:"label",text:"Withdraw interest",cls:"x-form-item-label",margin:"0 5 0 0"},{xtype:"button",id:"withdraw-button",text:"Withdraw",width:60,handler:function(g){g.hide();f.getComponent("withdraw-confirmation-button").show()}},{xtype:"button",id:"withdraw-confirmation-button",text:"Are you sure?",width:100,hidden:true,handler:function(h){d.setLoading(true);var g=d.miPlan;g.set("withdrawn",true);d.miPlan.save({success:function(){d.setLoading(false);d.hide()}});h.hide();f.getComponent("withdraw-button").show()}}]});var a=Ext.create("Ext.panel.Panel",{ui:"plain",layout:{type:"hbox",align:"stretchmax"},margin:"0 0 10 0",items:[{xtype:"label",text:"Inactivate plan?",cls:"x-form-item-label",margin:"0 5 0 0"},{xtype:"button",id:"inactivate-button",text:"Inactivate",width:60,handler:function(g){g.hide();a.getComponent("inactivate-confirmation-button").show()}},{xtype:"button",id:"inactivate-confirmation-button",text:"Are you sure?",width:100,hidden:true,handler:function(h){d.setLoading(true);var g=d.miPlan;g.set("is_active",false);d.miPlan.save({success:function(){d.setLoading(false);d.hide()}});h.hide();a.getComponent("inactivate-button").show()}}]});var c=420;if(window.CAN_SEE_SUB_PROJECT){c=440}this.add(Ext.create("Ext.panel.Panel",{height:c,ui:"plain",layout:{type:"vbox",align:"stretchmax"},padding:15,items:[d.form,e,f,a]}));d.updateButton=Ext.getCmp("update-button");this.addListener("hide",function(){d.updateButton.enable()});d.withdrawButton=Ext.getCmp("withdraw-button");d.inactivateButton=Ext.getCmp("inactivate-button");this.fields=this.form.items.keys;this.updateableFields=this.form.items.filterBy(function(g){return g.readOnly!=true}).keys},edit:function(b){var a=this;Imits.model.MiPlan.load(b,{success:function(c){a.miPlan=c;Ext.each(a.fields,function(d){var e=a.form.getComponent(d);if(e){e.setValue(a.miPlan.get(d))}});a.show();if(Ext.Array.indexOf(window.WITHDRAWABLE_STATUSES,c.get("status_name"))==-1){a.withdrawButton.disable()}else{a.withdrawButton.enable()}}})},updateAndHide:function(){var a=this;Ext.each(this.updateableFields,function(b){var c=a.form.getComponent(b);if(c){a.miPlan.set(b,c.getValue())}});a.miPlan.save({success:function(){a.hide()},failure:function(){a.updateButton.enable()}})}});function splitResultString(a){var c=[];var b=/^\[(.+)\:(.+)\:(\d+)\]$/;Ext.Array.each(a.split("<br/>"),function(d){var e=b.exec(d);c.push({consortium:e[1],production_centre:e[2],count:e[3]})});return c}function printMiPlanString(a){var b="["+a.consortium;if(!Ext.isEmpty(a.production_centre)){b=b+":"+a.production_centre}if(!Ext.isEmpty(a.status_name)){b=b+":"+a.status_name}b=b+"]";return b}Ext.define("Imits.widget.GeneGrid",{extend:"Imits.widget.Grid",requires:["Imits.model.Gene","Imits.widget.grid.RansackFiltersFeature","Imits.widget.SimpleCombo","Imits.widget.MiPlanEditor","Ext.ux.RowExpander","Ext.selection.CheckboxModel"],title:"Please Select the Genes You Would Like to Register Interest In*",iconCls:"icon-grid",columnLines:true,store:{model:"Imits.model.Gene",autoLoad:true,remoteSort:true,remoteFilter:true,pageSize:20},selModel:Ext.create("Ext.selection.CheckboxModel"),features:[{ftype:"ransack_filters",local:false}],columns:[{header:"Gene",dataIndex:"marker_symbol",readOnly:true,renderer:function(a){return Ext.String.format('<a href="http://www.knockoutmouse.org/martsearch/search?query={0}" target="_blank">{0}</a>',a)}},{header:"# IKMC Projects",dataIndex:"ikmc_projects_count",readOnly:true},{header:"# Clones",dataIndex:"pretty_print_types_of_cells_available",readOnly:true,sortable:false},{header:"Non-Assigned Plans",dataIndex:"non_assigned_mi_plans",readOnly:true,sortable:false,width:250,flex:1,xtype:"templatecolumn",tpl:new Ext.XTemplate('<tpl for="non_assigned_mi_plans">','<a class="mi-plan" data-marker_symbol="{parent.marker_symbol}" data-id="{id}" data-string="{[this.prettyPrintMiPlan(values)]}" href="#">{[this.prettyPrintMiPlan(values)]}</a><br/>',"</tpl>",{prettyPrintMiPlan:printMiPlanString})},{header:"Assigned Plans",dataIndex:"assigned_mi_plans",readOnly:true,sortable:false,width:180,flex:1,xtype:"templatecolumn",tpl:new Ext.XTemplate('<tpl for="assigned_mi_plans">','<a class="mi-plan" data-marker_symbol="{parent.marker_symbol}" data-id="{id}" data-string="{[this.prettyPrintMiPlan(values)]}" href="#">{[this.prettyPrintMiPlan(values)]}</a><br/>',"</tpl>",{prettyPrintMiPlan:printMiPlanString})},{header:"Aborted MIs",dataIndex:"pretty_print_aborted_mi_attempts",readOnly:true,sortable:false,width:180,flex:1,xtype:"templatecolumn",tpl:new Ext.XTemplate('<tpl for="this.processedMIs(pretty_print_aborted_mi_attempts)">','<a href="'+window.basePath+'/mi_attempts?q[terms]={parent.marker_symbol}&q[production_centre_name]={production_centre}" target="_blank">[{consortium}:{production_centre}:{count}]</a></br>',"</tpl>",{processedMIs:splitResultString})},{header:"MIs in Progress",dataIndex:"pretty_print_mi_attempts_in_progress",readOnly:true,sortable:false,width:180,flex:1,xtype:"templatecolumn",tpl:new Ext.XTemplate('<tpl for="this.processedMIs(pretty_print_mi_attempts_in_progress)">','<a href="'+window.basePath+'/mi_attempts?q[terms]={parent.marker_symbol}&q[production_centre_name]={production_centre}" target="_blank">[{consortium}:{production_centre}:{count}]</a></br>',"</tpl>",{processedMIs:splitResultString})},{header:"Genotype Confirmed MIs",dataIndex:"pretty_print_mi_attempts_genotype_confirmed",readOnly:true,sortable:false,width:180,flex:1,xtype:"templatecolumn",tpl:new Ext.XTemplate('<tpl for="this.processedMIs(pretty_print_mi_attempts_genotype_confirmed)">','<a href="'+window.basePath+'/mi_attempts?q[terms]={parent.marker_symbol}&q[production_centre_name]={production_centre}" target="_blank">[{consortium}:{production_centre}:{count}]</a></br>',"</tpl>",{processedMIs:splitResultString})},{header:"Phenotype Attempts",dataIndex:"pretty_print_phenotype_attempts",readOnly:true,sortable:false,width:180,flex:1,xtype:"templatecolumn",tpl:new Ext.XTemplate('<tpl for="this.processedMIs(pretty_print_phenotype_attempts)">','<a href="'+window.basePath+'/phenotype_attempts?q[terms]={parent.marker_symbol}&q[production_centre_name]={production_centre}" target="_blank">[{consortium}:{production_centre}:{count}]</a></br>',"</tpl>",{processedMIs:splitResultString})}],createComboBox:function(e,d,a,b,c){if(c){b=Ext.Array.merge([null],b)}return Ext.create("Imits.widget.SimpleCombo",{id:e+"Combobox",store:b,fieldLabel:d,labelAlign:"right",labelWidth:a,storeOptionsAreSpecial:true})},registerInterestHandler:function(){var e=this;var d=0;var b=e.getSelectionModel().selected;var g=[];var f=e.consortiumCombo.getSubmitValue();var c=e.centreCombo.getSubmitValue();var a=e.priorityCombo.getSubmitValue();if(b.length==0){alert("You must select some genes to register interest in");return}if(f==null){alert("You must select a consortium");return}if(a==null){alert("You must selct a priority");return}e.setLoading(true);b.each(function(i){var j=i.raw.marker_symbol;var h=Ext.create("Imits.model.MiPlan",{marker_symbol:j,consortium_name:f,production_centre_name:c,priority_name:a});h.save({failure:function(){g.push(j)},callback:function(){d++;if(d==b.length){if(!Ext.isEmpty(g)){alert("An error occured trying to register interest on the following genes: "+g.join(", ")+". Please try again.")}e.reloadStore();e.setLoading(false)}}})})},initMiPlanEditor:function(){var a=this;this.miPlanEditor=Ext.create("Imits.widget.MiPlanEditor",{listeners:{hide:{fn:function(){a.reloadStore();a.setLoading(false)}}}});Ext.get(a.renderTo).on("click",function(b,c){var d=c.getAttribute("data-id");a.setLoading("Editing gene interest....");a.miPlanEditor.edit(d)},a,{delegate:"a.mi-plan"})},initComponent:function(){var a=this;a.callParent();a.addDocked(Ext.create("Ext.toolbar.Paging",{store:a.getStore(),dock:"bottom",displayInfo:true}));a.consortiumCombo=a.createComboBox("consortium","Consortium",65,window.CONSORTIUM_OPTIONS);a.centreCombo=a.createComboBox("production_centre","Production Centre",100,window.CENTRE_OPTIONS,true);a.priorityCombo=a.createComboBox("priority","Priority",47,window.PRIORITY_OPTIONS);a.addDocked(Ext.create("Ext.toolbar.Toolbar",{dock:"top",items:[a.consortiumCombo,a.centreCombo,a.priorityCombo,"  ",{id:"register_interest_button",text:"Register Interest",cls:"x-btn-text-icon",iconCls:"icon-add",grid:a,handler:function(){a.registerInterestHandler()}}]}));this.initMiPlanEditor()}});Ext.define("Imits.widget.MiPlansGrid",{extend:"Imits.widget.Grid",requires:["Imits.model.MiPlan","Imits.widget.grid.MiPlanRansackFiltersFeature","Imits.widget.MiPlanEditor"],title:"Your Plans",iconCls:"icon-grid",columnLines:true,store:{model:"Imits.model.MiPlan",autoLoad:true,remoteSort:true,remoteFilter:true,pageSize:20},selType:"rowmodel",features:[{ftype:"mi_plan_ransack_filters",local:false}],initComponent:function(){var a=this;a.callParent();a.addDocked(Ext.create("Ext.toolbar.Paging",{store:a.getStore(),dock:"bottom",displayInfo:true}));a.miPlanEditor=Ext.create("Imits.widget.MiPlanEditor",{listeners:{hide:{fn:function(){a.reloadStore();a.setLoading(false)}}}});a.addListener("itemclick",function(c,b){var d=b.data.id;a.setLoading("Editing plan....");a.miPlanEditor.edit(d)});a.addListener("afterrender",function(){if(window.CAN_SEE_SUB_PROJECT){var b=Ext.Array.filter(a.columns,function(d){return d.dataIndex==="sub_project_name"})[0];b.setVisible(true);var c=Ext.Array.filter(a.columns,function(d){return d.dataIndex==="is_bespoke_allele"})[0];c.setVisible(true)}})},columns:[{dataIndex:"marker_symbol",header:"Marker Symbol",readOnly:true,filter:{type:"string"}},{dataIndex:"id",header:"ID",readOnly:true,hidden:true},{dataIndex:"consortium_name",header:"Consortium",readOnly:true,width:115,filter:{type:"list",options:window.CONSORTIUM_OPTIONS}},{dataIndex:"is_bespoke_allele",header:"Bespoke allele?",xtype:"boolgridcolumn",readOnly:true,hidden:true},{dataIndex:"sub_project_name",header:"Sub-Project",readOnly:true,width:150,filter:{type:"list",options:window.SUB_PROJECT_OPTIONS},hidden:true},{dataIndex:"production_centre_name",header:"Production Centre",readOnly:true,width:115,filter:{type:"list",options:window.CENTRE_OPTIONS}},{dataIndex:"priority_name",header:"Priority",readOnly:true,filter:{type:"list",options:window.PRIORITY_OPTIONS}},{dataIndex:"status_name",header:"Status",readOnly:true,flex:1,filter:{type:"list",options:window.STATUS_OPTIONS}}]});